<!--
  APP: AI Strategy Room (AIä¼šè­°å®¤)
  FILE: index.html
  VERSION: v0216.3.8-hf3-full
  DATE(JST): 26-01-10 16:12 JST
  TITLE: æ¤œè¨¼ä¿®æ­£ï¼šéå»ãƒ­ã‚°å¾©å…ƒã§ã‚¿ã‚¤ãƒˆãƒ«/è­°é¡Œã‚’å¾©æ´»ï¼‹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®å¸ä¼šå¹²æ¸‰æ’é™¤ï¼‹è¡¨ç¤ºåï¼ˆAlpha/Betaå»ƒæ­¢ï¼‰ï¼‹çµ‚ç«¯ãƒãƒ¼ã‚«ãƒ¼æŒ‡ç¤ºï¼‹é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿å¾©æ´»ï¼ˆUIãã®ã¾ã¾ï¼‰
  CHANGES:
  - ã€æœ€é‡è¦ã€‘éå»ãƒ­ã‚°èª­ã¿è¾¼ã¿æ™‚ã«ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€ã€Œè­°é¡Œã€ã‚’å¾©å…ƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«session metaä¿å­˜ï¼‰
  - ã€æœ€é‡è¦ã€‘ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å¸ä¼šè€…ï¼ˆã‚ªãƒ¼ãƒˆã®MCï¼‰ãŒé¸æŠåˆ¶é™ã«å½±éŸ¿ã—ãªã„ã‚ˆã†åˆ†é›¢
  - è¡¨ç¤ºåã®æ”¹å–„ï¼šAlpha/Betaå‘¼ç§°ã‚’å»ƒæ­¢ã—ã€æ—¢å®šã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åï¼‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘½åã‚’å„ªå…ˆ
  - é€”ä¸­ã§åˆ‡ã‚Œã«ããã™ã‚‹æŒ‡ç¤ºï¼šå„AIã¯æœ«å°¾ã‚’ã€Œä»¥ä¸Šã€‚ã€ã§çµ‚ãˆã‚‹ï¼ˆdetectCutã‚‚èª¤æ¤œçŸ¥ä½æ¸›ï¼‰
  - é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿å¾©æ´»ï¼šã‚ªãƒ¼ãƒˆ/ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¨ã‚‚ã«é€²æ—ãƒãƒ¼ã‚’æ§‹ç¯‰ã—ã¦è¡¨ç¤º
  AUTHOR: Yuiï¼ˆFix/Integrationï¼‰
  BUILD_PARAM: ?b=2026-01-10_1612_hf3-full
  DEBUG_PARAM: &debug=1
-->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Round Table v16.3.8-hf3-full</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(typeof pdfjsLib!=='undefined')pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
  :root { 
    --bg-color: #f0f2f5; --card-bg: #ffffff; --text-main: #333; 
    --shadow-btn: 0 4px 6px rgba(0,0,0,0.1);
    
    /* AI Theme Colors */
    --col-yui: #ec4899; --col-gemini: #8b5cf6; --col-rex: #f59e0b;
    --col-deepseek: #3b82f6; --col-llama: #06b6d4; --col-qwen: #84cc16;
    --col-mistral: #a855f7; --col-dolphin: #ef4444;
    
    /* Role Colors */
    --role-proposer: #3b82f6;
    --role-opposer: #ef4444;
    --role-tech: #eab308;
    --role-observer: #94a3b8;
  }

  body { background-color: var(--bg-color); font-family: 'Helvetica Neue', Arial, sans-serif; color: var(--text-main); margin: 0; padding: 20px; font-size: 16px; transition: font-size 0.2s; }
  .container { max-width: 1400px; margin: 0 auto; }
  .card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); padding: 24px; margin-bottom: 24px; border: 1px solid #e5e7eb; }

  /* Header */
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
  .app-title { font-size: 1.5rem; font-weight: 800; color: #1f2937; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
  .app-meta { font-size: 0.75rem; color: #64748b; font-weight: normal; margin-top: 4px; background: #e2e8f0; padding: 2px 8px; border-radius: 4px; display: inline-block; width: fit-content; }

  /* Buttons & Inputs */
  .btn, .mode-btn, .agent-badge { box-shadow: var(--shadow-btn); transition: 0.2s; cursor: pointer; font-weight: bold; border: none; }
  .btn:active, .mode-btn:active, .agent-badge:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .btn { padding: 0 20px; height: 44px; border-radius: 22px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.95rem; }
  .btn-secondary { background: #fff; border: 1px solid #cbd5e1; color: #475569; }
  .btn-secondary:hover { background: #f8fafc; border-color: #94a3b8; }
  .btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; }
  .btn-primary:hover { filter: brightness(1.1); }
  .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
  .btn-danger:hover { filter: brightness(1.1); }
  
  .title-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.1rem; box-sizing: border-box; }
  textarea { width: 100%; height: 150px; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; resize: vertical; box-sizing: border-box; font-family: monospace; }
  textarea:focus { border-color: #10b981; outline: none; background: #f0fdf4; }

  /* Settings Area */
  .settings-area { display: none; background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin-top: 15px; animation: fadeIn 0.3s; }
  .control-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
  .mode-switch { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; }
  .mode-btn { flex: 1; max-width: 200px; height: 50px; border: 2px solid #e2e8f0; background: #fff; color: #94a3b8; font-size: 1rem; border-radius: 25px; }
  .mode-btn.active { border-color: #10b981; color: #fff; background: linear-gradient(135deg, #10b981, #059669); }
  
  .badge-zone { flex-grow: 1; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .agent-badge { padding: 10px 18px; border-radius: 25px; background: #fff; border: 2px solid transparent; color: #64748b; font-size: 0.9rem; }
  .agent-badge.selected { color: white; }
  /* Agent Colors */
  [data-agent="yui"].selected { background: var(--col-yui); }
  [data-agent="gemini"].selected { background: var(--col-gemini); }
  [data-agent="rex"].selected { background: var(--col-rex); }
  [data-agent="deepseek"].selected { background: var(--col-deepseek); }
  [data-agent="llama"].selected { background: var(--col-llama); }
  [data-agent="qwen"].selected { background: var(--col-qwen); }
  [data-agent="mistral"].selected { background: var(--col-mistral); }
  [data-agent="dolphin"].selected { background: var(--col-dolphin); }

  /* â˜…ç”»åƒãƒ›ãƒãƒ¼æ‹¡å¤§ (Wikipediaé¢¨ãƒ»å·¨å¤§åŒ–ç‰ˆ)â˜… */
  .preview-wrapper { position: relative; display: inline-block; margin-right: 8px; margin-bottom: 8px; }
  .preview-thumb { height: 50px; border-radius: 4px; border: 2px solid #cbd5e1; cursor: pointer; transition: 0.2s; background: white; object-fit: cover; }
  .preview-thumb:hover { border-color: #10b981; transform: scale(1.05); }
  
  .preview-popup {
    display: none;
    position: absolute;
    bottom: 60px;
    left: 0;
    width: 400px;
    max-width: 80vw;
    background: white;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    border: 1px solid #cbd5e1;
    z-index: 9999;
    animation: fadeIn 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28);
  }
  .preview-popup img { width: 100%; height: auto; border-radius: 8px; display: block; }
  .preview-wrapper:hover .preview-popup { display: block; }
  .preview-popup::after {
    content: ""; position: absolute; top: 100%; left: 20px;
    border-width: 10px; border-style: solid; border-color: white transparent transparent transparent;
  }

  /* Log List Styles */
  .log-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #e2e8f0; background: #fff; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f1f5f9; }
  .log-item:hover { background: #f8fafc; border-color: #cbd5e1; }
  .log-text { cursor: pointer; flex-grow: 1; color: #334155; font-weight: bold; font-size: 0.95rem; }
  .log-text:hover { color: #2563eb; }
  .log-del-btn { background: #ef4444; color: white; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; font-weight: bold; border: none; }
  .log-del-btn:hover { background: #dc2626; }

  /* Timeline & Cards */
  .main-stage { display: none; margin-top: 20px; }
  .timeline { display: flex; flex-direction: column; gap: 20px; }
  .timeline-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid #eee; border-left: 5px solid transparent; transition: 0.3s; }
  .tl-header { padding: 10px 15px; font-size: 0.9rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  .tl-body { padding: 15px 20px; font-size: 1rem; line-height: 1.7; color: #333; }
  
  .role-proposer { border-color: var(--role-proposer); }
  .role-opposer { border-color: var(--role-opposer); }
  .role-tech { border-color: var(--role-tech); }
  .role-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; color: #fff; margin-left: 8px; vertical-align: middle; }
  
  .manual-grid { display: none; grid-template-columns: repeat(4, 1fr); gap: 16px; }
  @media (max-width: 1000px) { .manual-grid { grid-template-columns: repeat(2, 1fr); } }
  .mini-col { height: 500px; display: flex; flex-direction: column; background: #fff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .mini-head { padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #eee; }
  .mini-body { overflow-y: auto; flex: 1; padding: 10px; }
  
  /* Utilities */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(3px); }
  .modal-content { background: #fff; width: 90%; max-width: 800px; max-height: 80vh; border-radius: 16px; padding: 25px; display: flex; flex-direction: column; }
  .font-ctrl-group { display: flex; background: #fff; border-radius: 20px; padding: 3px; border: 1px solid #cbd5e1; }
  .font-btn { border: none; background: transparent; padding: 5px 12px; cursor: pointer; font-size: 0.8rem; color: #64748b; border-radius: 16px; }
  .font-btn.active { background: #334155; color: #fff; }
  .code-link-btn { display: inline-block; background: #1e293b; color: #fff; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-family: monospace; font-size: 0.85rem; cursor: pointer; margin: 8px 0; border: none; }
  .code-modal-content { width: 95%; max-width: 1200px; height: 90vh; background: #1e1e1e; color: #fff; padding: 0; }
  .code-modal-body { flex: 1; overflow: auto; padding: 20px; }
  
  /* Progress */
  .progress-zone { max-width: 1400px; margin: 20px auto; padding: 20px; background: rgba(255,255,255,0.95); border-radius: 16px; display: none; border: 1px solid #e5e7eb; overflow-x: auto; }
  .progress-bar { display: flex; justify-content: space-between; position: relative; min-width: 100%; }
  .progress-line { position: absolute; top: 15px; left: 0; right: 0; height: 4px; background: #e2e8f0; z-index: 0; }
  .step { position: relative; z-index: 1; text-align: center; width: 80px; flex-shrink: 0; }
  .step-dot { width: 34px; height: 34px; background: #e2e8f0; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #94a3b8; transition: 0.3s; border: 2px solid #fff; }
  .step.active .step-dot { background: #10b981; color: #fff; transform: scale(1.1); }
  .step-label { font-size: 0.75rem; color: #64748b; font-weight: bold; }
  
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div class="container" id="appContainer">
  <div class="header">
    <div style="display:flex; align-items:center; gap:10px;">
      <div class="app-title">AI Round Table <span class="app-meta">v16.3.8-hf3-full</span></div>
    </div>
    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <div class="font-ctrl-group">
        <button class="font-btn" onclick="setFontSize('small')">å°</button>
        <button class="font-btn active" onclick="setFontSize('medium')" id="btn-font-m">ä¸­</button>
        <button class="font-btn" onclick="setFontSize('large')">å¤§</button>
      </div>
      <button class="btn btn-secondary" onclick="openHistoryModal()">ğŸ“‚ ãƒ­ã‚°</button>
      <button class="btn btn-secondary" onclick="tryReset()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn btn-secondary" onclick="openSettingsModal()">âš™ è¨­å®š</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <div id="statusText" style="font-weight:bold; color:#10b981;">å¾…æ©Ÿä¸­...</div>
      <div id="clock" style="color:#94a3b8; font-weight:bold;"></div>
    </div>

    <input type="text" id="topicTitle" class="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: æ–°è¦äº‹æ¥­æ¡ˆã®æ¤œè¨)">
    <textarea id="themeInput" placeholder="ã“ã“ã«è­°é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
    
    <div style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px;">
      <input type="file" id="fileInput" hidden multiple onchange="handleFileSelect(event)">
      <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">ğŸ“· ç”»åƒ</button>
      <button class="btn btn-secondary" onclick="pasteFromClipboard()">ğŸ“‹ è²¼ä»˜</button>
      <button class="btn btn-secondary" onclick="insertTemplate()" style="color:#3b82f6; border-color:#3b82f6;">ğŸ“„ Codeè²¼ä»˜æ </button>
      <button class="btn btn-secondary" onclick="resetInput()">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
      <button class="btn btn-secondary" onclick="uploadCode()">ğŸ’¾ GitHub</button>
    </div>
    <div id="previewArea" style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap; min-height:10px;"></div>

    <hr style="border:0; border-top:1px solid #e2e8f0; margin:25px 0;">

    <div style="text-align:center; margin-bottom:10px; font-weight:bold; color:#64748b;">STEP 1: ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</div>
    <div class="mode-switch">
      <button id="mode-auto" class="mode-btn" onclick="setMode('auto')">ğŸ¤– ã‚ªãƒ¼ãƒˆ (å††å“ä¼šè­°)</button>
      <button id="mode-manual" class="mode-btn" onclick="setMode('manual')">ğŸ“ ãƒãƒ‹ãƒ¥ã‚¢ãƒ« (ä¸¦åˆ—)</button>
    </div>

    <div id="settingsArea" class="settings-area">
      <div style="margin-bottom:10px; font-weight:bold; color:#64748b;">STEP 2: å‚åŠ AIã¨å½¹å‰²ã®è¨­å®š</div>
      <div class="control-row">
        <div id="mcWrapper" class="mc-zone" style="margin-right:15px;">
          <label style="font-weight:bold; margin-right:5px; color:#475569;">ğŸ¤ å¸ä¼š:</label>
          <select id="mcSelect" class="mc-select"></select>
        </div>
        <div id="roundWrapper" style="display:none; margin-right:15px;">
          <label style="font-weight:bold; margin-right:5px; color:#475569;">ğŸ”„ è­°è«–:</label>
          <select id="roundSelect" class="mc-select">
            <option value="1">1ã‚¯ãƒ¼ãƒ« (å³æ±º)</option>
            <option value="2" selected>2ã‚¯ãƒ¼ãƒ« (æ·±å €)</option>
            <option value="3">3ã‚¯ãƒ¼ãƒ« (å¾¹åº•)</option>
          </select>
        </div>
        <div class="badge-zone" id="agentBadges"></div>
        <div class="start-zone">
          <button id="startBtn" class="btn btn-primary" onclick="startProcess()">ğŸš€ ä¼šè­°ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="progressZone" class="progress-zone">
    <div class="progress-bar" id="progressBarInner"></div>
  </div>

  <div id="mainStage" class="main-stage">
    <div style="font-size:1.2rem; font-weight:800; margin-bottom:15px; border-left:6px solid #333; padding-left:15px; color:#333;">ğŸ”´ LIVE TIMELINE</div>
    <div id="timeline" class="timeline"></div>
  </div>

  <div id="manualGrid" class="manual-grid"></div>
</div>

<div id="historyModal" class="modal-overlay"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><h2>ğŸ“‚ éå»ãƒ­ã‚°</h2><button onclick="closeHistoryModal()" class="btn btn-secondary">âœ•</button></div><div id="logList" style="overflow-y:auto;flex:1;"></div></div></div>
<div id="resetModal" class="modal-overlay"><div class="modal-content" style="max-width:400px;text-align:center;"><h3 style="margin-top:0;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</h3><p style="color:#666;">ç”»é¢ã®å†…å®¹ã¨ä¸€æ™‚ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚<br>(éå»ãƒ­ã‚°ã¯æ¶ˆãˆã¾ã›ã‚“)</p><div style="display:flex;justify-content:center;gap:10px;margin-top:20px;"><button class="btn btn-secondary" onclick="closeModal('resetModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-danger" onclick="performReset()">å®Ÿè¡Œã™ã‚‹</button></div></div></div>
<div id="codeModal" class="modal-overlay" style="z-index:3000;"><div class="modal-content code-modal-content"><div style="padding:15px;background:#2d2d2d;display:flex;justify-content:space-between;"><span style="font-weight:bold;color:#fff;">ğŸ“œ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</span><div><button class="btn btn-primary" style="height:32px;font-size:0.8rem;" onclick="copyCode()">ã‚³ãƒ”ãƒ¼</button> <button onclick="closeModal('codeModal')" class="btn btn-secondary" style="background:#444;color:#fff;border:none;">âœ•</button></div></div><div class="code-modal-body"><pre><code id="codeViewerContent"></code></pre></div></div></div>

<div id="settingsModal" class="modal-overlay"><div class="modal-content" style="max-width:600px;max-height:90vh;overflow-y:auto;">
  <div style="display:flex;justify-content:space-between;margin-bottom:20px;align-items:center;">
    <h2 style="margin:0;">âš™ è¨­å®š</h2>
    <button onclick="closeSettingsModal()" class="btn btn-secondary">âœ•</button>
  </div>
  <div style="display:flex;flex-direction:column;gap:20px;">
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ“Š è¦ç´„ãƒ¬ãƒ™ãƒ«</label>
      <select id="settingSummaryLevel" style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.95rem;">
        <option value="simple">ç°¡å˜ï¼ˆçµè«–â†’ç®‡æ¡æ›¸ã3ã¤â†’æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰</option>
        <option value="standard" selected>æ¨™æº–ï¼ˆçµè«–â†’ç†ç”±â†’æ‰‹é †ï¼‰</option>
        <option value="detailed">è©³ç´°ï¼ˆå‰æâ†’åˆ¤æ–­â†’æ‰‹é †â†’æ³¨æ„ç‚¹ï¼‰</option>
      </select>
    </div>
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ’¬ ä¼šè©±ãƒˆãƒ¼ãƒ³</label>
      <select id="settingConversationTone" style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.95rem;">
        <option value="first">åˆã‚ã¦ï¼ˆä¸å¯§ã‚ï¼‰</option>
        <option value="friendly" selected>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ï¼ˆæŸ”ã‚‰ã‹ã‚ï¼‰</option>
        <option value="business">ä»•äº‹ï¼ˆç”¨ä»¶ä¸­å¿ƒã§çŸ­ãï¼‰</option>
      </select>
    </div>
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;cursor:pointer;">
        <input type="checkbox" id="settingPoliteSuppress" style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
        ä¸å¯§ã™ãæŠ‘åˆ¶ï¼ˆå‰ç½®ããƒ»æŒ¨æ‹¶ã‚’å‰Šã‚‹ï¼‰
      </label>
    </div>
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ“Š ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿è¡¨ç¤º</label>
      <div style="display:flex;flex-direction:column;gap:8px;padding:12px;background:#f8fafc;border-radius:8px;">
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorThinking" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          Thinkingï¼ˆæ€è€ƒä¸­ï¼‰
        </label>
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorTimeout" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          Timeoutï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
        </label>
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorCut" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          CUTï¼ˆä¼šè©±ãŒé€”ä¸­ã§åˆ‡ã‚ŒãŸï¼‰
        </label>
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorLate" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          Lateï¼ˆé…å»¶ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—ï¼‰
        </label>
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorError" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          Errorï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰
        </label>
      </div>
    </div>
  </div>
  <div style="display:flex;justify-content:center;gap:10px;margin-top:25px;">
    <button class="btn btn-secondary" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-primary" onclick="saveSettingsAndClose()">ä¿å­˜</button>
  </div>
</div></div>

<script>
const AGENTS = ['yui','gemini','rex','deepseek','llama','qwen','mistral','dolphin'];

// selected: ç©ºã‚»ãƒƒãƒˆ = å…¨å“¡ï¼ˆé‹ç”¨çµ±ä¸€ï¼‰
let selected = ['yui','gemini','rex','deepseek'];

let currentMode = null;
let imagesBase64 = []; 
let context = ""; 
let sessionId = "SESS_"+Date.now();
let codeSnippets = [];
let assignedRoles = {};

// ç”»é¢å¾©å…ƒï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³HTMLï¼‰ã ã‘ã§ãªãã€ã‚¿ã‚¤ãƒˆãƒ«/è­°é¡Œã‚‚å¾©å…ƒã™ã‚‹ãŸã‚ meta ã‚’ä¿å­˜
const STORAGE_KEY = 'ai_round_v16_3_3';                 // å¾“æ¥äº’æ›ï¼ˆmainStage.innerHTMLï¼‰
const STORAGE_META_KEY = 'ai_round_meta_v16_3_8_hf3';    // è¿½åŠ ï¼ˆtitle/theme/sessionIdãªã©ï¼‰
const SETTINGS_STORAGE_KEY = 'ai_round_settings_v16_3_7';

// â˜…è¨­å®šå€¤ï¼ˆlocalStorageã‹ã‚‰å¾©å…ƒï¼‰â˜…
let settings = {
  summaryLevel: 'standard',
  conversationTone: 'friendly',
  politeSuppress: false,
  indicators: {
    thinking: true,
    timeout: true,
    cut: true,
    late: true,
    error: true
  }
};

function loadSettings() {
  try {
    const saved = localStorage.getItem(SETTINGS_STORAGE_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      settings = { ...settings, ...parsed, indicators: { ...settings.indicators, ...(parsed.indicators || {}) } };
    }
  } catch (e) {
    console.warn('Settings load failed:', e);
  }
}
function saveSettings() {
  try {
    localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
  } catch (e) {
    console.warn('Settings save failed:', e);
  }
}

/* =========================================================
   v16.3.8-hf3-full: è¡¨ç¤ºåï¼ˆAlpha/Betaå»ƒæ­¢ï¼‰ï¼‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘½åå„ªå…ˆ
========================================================= */
function _getUserNamedLabel_(agentKey) {
  try {
    const k = `ai_name_${agentKey}`;
    const v = localStorage.getItem(k);
    if (v && String(v).trim()) return String(v).trim();
  } catch (e) {}
  return "";
}
function _platformName_(agentKey) {
  const map = {
    yui: 'ChatGPT',
    gemini: 'Gemini',
    rex: 'Cursor',
    deepseek: 'DeepSeek',
    llama: 'Llama',
    qwen: 'Qwen',
    mistral: 'Mistral',
    dolphin: 'Dolphin'
  };
  return map[String(agentKey || '').toLowerCase()] || (String(agentKey||'AI').charAt(0).toUpperCase()+String(agentKey||'AI').slice(1));
}
function normalizeDisplayName(speaker, role) {
  const lowerSpeaker = String(speaker || '').toLowerCase();

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘½åãŒã‚ã‚Œã°æœ€å„ªå…ˆ
  const userNamed = _getUserNamedLabel_(lowerSpeaker);
  if (userNamed) return userNamed;

  // å½¹å‰²ãƒ©ãƒ™ãƒ«â†’ãƒ¢ãƒ‡ãƒ«åï¼ˆå¿…è¦æœ€å°é™ï¼‰
  const roleToModelMap = {
    'ImageAnalyzer': 'Gemini',
    'FactChecker': 'Gemini',
    'CodeReviewer': 'Cursor',
    'TechAdvisor': 'Cursor',
    'Proposer': 'Gemini',
    'Opposer': 'Gemini',
    'Observer': 'Gemini'
  };
  const roleKey = String(role || speaker || '').replace(/[^a-zA-Z0-9]/g, '');
  if (roleToModelMap[roleKey]) return roleToModelMap[roleKey];

  // æ—¢å®šã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åï¼ˆAlpha/Betaå»ƒæ­¢ï¼‰
  return _platformName_(lowerSpeaker);
}

/* =========================================================
   v16.3.8-hf3-full: CUTèª¤æ¤œçŸ¥ä½æ¸›ï¼ˆæœ«å°¾ãƒãƒ¼ã‚«ãƒ¼ã€Œä»¥ä¸Šã€‚ã€æŒ‡ç¤ºã¨ä½µç”¨ï¼‰
========================================================= */
function _detectCut_(text) {
  if (!text || typeof text !== 'string') return false;

  let clean = text
    .replace(/<[^>]+>/g, '')
    .replace(/[ï¼Š*`_~\[\](){}#]/g, '')
    .trim();
  if (!clean) return false;

  const lines = clean.split(/\n/).map(s => s.trim()).filter(Boolean);
  if (!lines.length) return false;

  const last = lines[lines.length - 1];
  if (!last || last.length < 3) return false;

  // çµ‚ç«¯ãƒãƒ¼ã‚«ãƒ¼ã¯CUTã«ã—ãªã„
  if (/(ä»¥ä¸Šã€‚|ä»¥ä¸Šï¼|ä»¥ä¸Š\!|çµ‚ã‚ã‚Šã€‚|çµ‚ã‚ã‚Šï¼)$/.test(last)) return false;

  if (/[ã€‚ï¼ï¼Ÿ!?\.]$/.test(last)) return false;
  if (/[\.ï¼â€¦]{2,}$/.test(last)) return true;

  const short = last.length <= 28;

  // ã‚ˆãã‚ã‚‹èªå°¾ï¼ˆã /ã‚ˆ/ã­/ã‚/ãªï¼‰ã¯CUTå€™è£œã‹ã‚‰é™¤å¤–ï¼ˆhf1ã‹ã‚‰ç¶™ç¶šï¼‰
  if (short && /(ã |ã‚ˆ|ã­|ã‚|ãª)$/.test(last)) return false;

  if (short && /(ã®|ãŒ|ã‚’|ã«|ã§|ã¨|ã¯|ã‚‚|ã‹|ã‚„|ã¸)$/.test(last)) return true;
  if (short && /(ã¦|ã®ã§|ã®ã«|ã‘ã©|ã‘ã‚Œã©|ã‹ã‚‰|ãŸã‚|ã¤ã¤)$/.test(last)) return true;
  if (short && /(ã‚ˆã†|ãã†|ã‚‰ã—ã„|ãŸã„|ãªã„)$/.test(last)) return true;

  return false;
}

/* =========================================================
   Markdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
========================================================= */
function formatMarkdown(text) {
  if (!text) return '';
  let formatted = text;

  formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (m, l, c) => {
    const i = codeSnippets.length; 
    codeSnippets.push({ l: l||'text', c: c.trim() });
    return `__CODE_${i}__`;
  });

  formatted = formatted.replace(/\n/g, '<br>');
  formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  formatted = formatted.replace(/__CODE_(\d+)__/g, (m, i) => {
    if (codeSnippets[i]) {
      return `<button class="code-link-btn" onclick="openCode(${i})">ğŸ“œ ã‚³ãƒ¼ãƒ‰ (${codeSnippets[i].l})</button>`;
    }
    return '';
  });

  return formatted;
}

/* =========================================================
   ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š
========================================================= */
function openModal(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'flex';
}
function closeModal(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'none';
}

window.onload = () => { 
  updateClock(); 
  setInterval(updateClock,60000); 
  loadSettings();
  initUI(); 
  applySettingsToUI();
  restoreFromStorage(); // â˜…éå»ãƒ­ã‚°/ã‚¿ã‚¤ãƒˆãƒ«/è­°é¡Œã®å¾©å…ƒ
};

function initUI() {
  const con = document.getElementById('agentBadges');
  const mcSel = document.getElementById('mcSelect');
  mcSel.innerHTML = ""; con.innerHTML = "";
  
  AGENTS.forEach(a => {
    const span = document.createElement('span');
    span.className = `agent-badge ${selected.includes(a)?'selected':''}`;
    span.setAttribute('data-agent', a); span.id = `badge-${a}`;
    span.innerText = _platformName_(a);
    span.onclick = () => toggleAgent(a);
    con.appendChild(span);

    const opt = document.createElement('option');
    opt.value = a; opt.innerText = _platformName_(a);
    mcSel.appendChild(opt);
  });

  // MCå¤‰æ›´ã¯ã‚ªãƒ¼ãƒˆæ™‚ã ã‘æ„å‘³ãŒã‚ã‚‹ã€‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®é¸æŠåˆ¶é™ã«å½±éŸ¿ã•ã›ãªã„
  mcSel.addEventListener('change', function() {
    if (currentMode !== 'auto') return;
    _updateBadgeStates_();
  });
  
  _updateBadgeStates_();
}

function updateClock(){
  document.getElementById('clock').innerText=new Date().toLocaleString('ja-JP',{hour:'2-digit',minute:'2-digit'});
}

function setFontSize(s) {
  const r = document.body; 
  document.querySelectorAll('.font-btn').forEach(b=>b.classList.remove('active'));
  if(s==='small'){r.style.fontSize='14px'; document.querySelectorAll('.font-btn')[0].classList.add('active');}
  if(s==='medium'){r.style.fontSize='16px'; document.querySelectorAll('.font-btn')[1].classList.add('active');}
  if(s==='large'){r.style.fontSize='20px'; document.querySelectorAll('.font-btn')[2].classList.add('active');}
}

function setMode(mode) {
  currentMode = mode;
  document.getElementById('mode-auto').classList.toggle('active', mode==='auto');
  document.getElementById('mode-manual').classList.toggle('active', mode==='manual');
  document.getElementById('settingsArea').style.display = 'block';
  document.getElementById('mcWrapper').style.display = (mode==='auto') ? 'block' : 'none';
  document.getElementById('roundWrapper').style.display = (mode==='auto') ? 'block' : 'none';
  document.getElementById('mainStage').style.display = 'none';
  document.getElementById('manualGrid').style.display = 'none';

  // é€²æ—ã¯ã€ã‚ªãƒ¼ãƒˆ/ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¨ã‚‚ä½¿ãˆã‚‹
  document.getElementById('progressZone').style.display = 'none';

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã« badge çŠ¶æ…‹ã‚’æ•´ãˆã‚‹ï¼ˆãŸã ã—ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã¯MCé™¤å¤–ã—ãªã„ï¼‰
  _updateBadgeStates_();
}

function toggleAgent(a) {
  // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã¯MCæ¦‚å¿µãŒç„¡ã„ã®ã§ã€é¸æŠåˆ¶é™ã‚’ã‹ã‘ãªã„
  if(selected.includes(a)) { 
    if(selected.length > 1) selected = selected.filter(x => x!==a); 
  } else {
    selected.push(a);
  }
  _updateBadgeStates_();
}

function _updateBadgeStates_() {
  const mc = document.getElementById('mcSelect')?.value;

  AGENTS.forEach(ag => {
    const el = document.getElementById(`badge-${ag}`);
    if (!el) return;

    // ã‚ªãƒ¼ãƒˆã®ã¿ï¼šMCã¯é¸æŠå¯¾è±¡ã‹ã‚‰å¤–ã™
    if (currentMode === 'auto' && ag === mc) {
      selected = selected.filter(x => x !== ag);
      el.classList.remove('selected');
      return;
    }

    if(selected.includes(ag)) el.classList.add('selected'); 
    else el.classList.remove('selected');
  });
}

function insertTemplate() {
  const t = document.getElementById('themeInput');
  const template = `\n--------------------------------------------------\nã€ãƒ•ã‚¡ã‚¤ãƒ«å: index.htmlã€‘\n(ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚‹)\n\n--------------------------------------------------\nã€ãƒ•ã‚¡ã‚¤ãƒ«å: Code.gsã€‘\n(ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚‹)\n`;
  t.value = t.value + template; t.focus();
}

function resetInput() { 
  document.getElementById('themeInput').value = ''; 
  imagesBase64 = []; 
  document.getElementById('previewArea').innerHTML = ''; 
}
function tryReset() { openModal('resetModal'); }
function performReset() { 
  localStorage.removeItem(STORAGE_KEY); 
  localStorage.removeItem(STORAGE_META_KEY);
  location.reload(); 
}

/* =========================================================
   é€²æ—ãƒãƒ¼ï¼ˆã‚ªãƒ¼ãƒˆ/ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å…±é€šã§ä½¿ãˆã‚‹ï¼‰
========================================================= */
function buildProgressBar(totalSteps) {
  const zone = document.getElementById('progressZone');
  const bar = document.getElementById('progressBarInner');
  if (!zone || !bar) return;

  zone.style.display = 'block';
  bar.innerHTML = '<div class="progress-line"></div>';
  for(let i=1; i<=totalSteps; i++) {
    let label = i===1 ? "é–‹å§‹" : i===totalSteps ? "å®Œäº†" : "è­°è«–";
    bar.innerHTML += `<div class="step" id="s${i}"><div class="step-dot">${i}</div><div class="step-label">${label}</div></div>`;
  }
}
function updateStep(s){ 
  const steps = document.querySelectorAll('.step');
  steps.forEach((el, idx) => { 
    if(idx+1 === s) el.classList.add('active'); 
    else el.classList.remove('active'); 
  });
}

/* =========================================================
   ä¼šè­°é–‹å§‹
========================================================= */
function startProcess() {
  const theme = document.getElementById('themeInput').value;
  if(!theme) return alert("è­°é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!currentMode) return alert("ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„");
  document.getElementById('statusText').innerText = "ğŸš€ å®Ÿè¡Œä¸­...";
  document.getElementById('statusText').style.color = '#10b981';
  if(currentMode === 'auto') startAuto(theme); else startManual(theme);
}

async function startAuto(theme) {
  document.getElementById('mainStage').style.display = 'block';
  document.getElementById('timeline').innerHTML = '';
  
  const mc = document.getElementById('mcSelect').value;
  const rounds = parseInt(document.getElementById('roundSelect').value, 10);
  
  let targets = selected.length > 0 ? selected.filter(a => a !== mc) : AGENTS.filter(a => a !== mc);
  if (targets.length < 2) {
    alert('ã‚ªãƒ¼ãƒˆä¼šè­°ã¯2äººä»¥ä¸Šã®AIãŒå¿…è¦ã§ã™ã€‚');
    document.getElementById('statusText').innerText = "âŒ ã‚¨ãƒ©ãƒ¼: AIãŒä¸è¶³";
    document.getElementById('statusText').style.color = 'red';
    return;
  }

  // é€²æ—ï¼ˆç›®å®‰ï¼‰ï¼šMCé–‹å§‹ + (rounds * targetsæ•°) + æœ€çµ‚ã¾ã¨ã‚
  const totalSteps = 1 + (rounds * (targets.length)) + 1;
  buildProgressBar(totalSteps);
  
  try {
    const participants = (selected.length > 0 ? selected : AGENTS).filter(a => a !== mc);
    const roles = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getRoleAssignment(participants, mc);
    });
    
    assignedRoles = roles;
    context = `[User]: ${theme}\n`;
    const title = document.getElementById('topicTitle').value;
    const imgs = [...imagesBase64];
    let stepCount = 1;

    // æœ«å°¾ãƒãƒ¼ã‚«ãƒ¼æŒ‡ç¤ºï¼ˆCUTæŠ‘åˆ¶ï¼‰
    const endMarker = "å¿…ãšå›ç­”ã®æœ€å¾Œã‚’ã€Œä»¥ä¸Šã€‚ã€ã§çµ‚ãˆã¦ãã ã•ã„ã€‚é€”ä¸­ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«æœ€å¾Œã¾ã§æ›¸ãåˆ‡ã£ã¦ãã ã•ã„ã€‚";

    const mcInstr = _applySettingsToInstruction_(`ãƒ¦ãƒ¼ã‚¶ãƒ¼è­°é¡Œ:ã€Œ${theme}ã€\nå¸ä¼šã¨ã—ã¦è­°è«–ã‚’é–‹å§‹ã—ã€å½¹å‰²ï¼ˆææ¡ˆè€…ãƒ»åè«–è€…ï¼‰ã‚’æŒ‡åã—ã¦è­°è«–ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚\n${endMarker}`);
    await runStep(mc, mcInstr, imgs, title, stepCount++, 'mc');

    for (let r = 1; r <= rounds; r++) {
      let prefix = (rounds > 1) ? `ã€ãƒ©ã‚¦ãƒ³ãƒ‰ ${r}/${rounds}ã€‘` : "";
      const proposers = targets.filter(a => assignedRoles[a] === 'proposer');
      for (const agent of proposers) {
        const proposerInstr = _applySettingsToInstruction_(`${prefix}ææ¡ˆè€…ã¨ã—ã¦ã€å…·ä½“çš„ã‹ã¤è«–ç†çš„ãªè§£æ±ºç­–ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚\n${endMarker}`);
        await runStep(agent, proposerInstr, imgs, title, stepCount++, 'proposer');
      }
      const others = targets.filter(a => assignedRoles[a] !== 'proposer');
      for (const agent of others) {
        let role = assignedRoles[agent];
        let msg = `${prefix}ææ¡ˆã«å¯¾ã—ã¦æ„è¦‹ã—ã¦ãã ã•ã„ã€‚`;
        if(role === 'opposer') msg = `${prefix}åè«–è€…ã¨ã—ã¦ã€ææ¡ˆã®ãƒªã‚¹ã‚¯ã‚„æ¬ é™¥ã‚’å³ã—ãæŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚`;
        if(role === 'tech') msg = `${prefix}æŠ€è¡“é¡§å•ã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚„å®Ÿè£…ã®å®Ÿç¾å¯èƒ½æ€§ã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„ã€‚`;
        const agentInstr = _applySettingsToInstruction_(msg + `\n${endMarker}`);
        await runStep(agent, agentInstr, imgs, title, stepCount++, role);
      }
    }

    const finalInstBase = `è­°è«–ã‚’ç·æ‹¬ã—ã€ææ¡ˆãƒ»åè«–ãƒ»æŠ€è¡“æ¤œè¨¼ã‚’çµ±åˆã—ã¦ã€æœ€çµ‚çš„ãªã€å®Œå…¨ãªè§£æ±ºç­–/ã‚³ãƒ¼ãƒ‰ã€‘ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n${endMarker}`;
    const finalInst = _applySettingsToInstruction_(finalInstBase);
    await runStep(mc, finalInst, imgs, title, stepCount, 'mc');
    
    document.getElementById('statusText').innerText = "âœ… å®Œäº†";
    document.getElementById('statusText').style.color = '#10b981';
    saveStorage();
  } catch (e) {
    document.getElementById('statusText').innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + (e.message || e);
    document.getElementById('statusText').style.color = 'red';
    console.error("startAuto error:", e);
  }
}

/* =========================================================
   CUTç¶™ç¶šï¼ˆhf1ãƒ™ãƒ¼ã‚¹ï¼‰
========================================================= */
function _handleCutContinuation_(
  speaker, responseText, ctx, imgs, sessionId, title, role,
  id, indicatorId, attemptCount, resolve
) {
  const MAX_CUT_ATTEMPTS = 2;

  const ansEl = document.getElementById(`ans-${id}`);
  const indicatorEl = document.getElementById(indicatorId);

  const setIndicator = (txt) => {
    if (!indicatorEl) return;
    if (!settings?.indicators?.cut) return;
    indicatorEl.textContent = txt;
  };

  if (attemptCount >= MAX_CUT_ATTEMPTS) {
    const cutEndMsg = `\n\n<span style="color:#f59e0b; font-weight:bold;">âœ‚ï¸ CUTã®ã¾ã¾çµ‚äº†ï¼ˆæ¬¡ã¸ï¼‰</span>`;
    if (ansEl) ansEl.innerHTML = formatMarkdown(responseText + cutEndMsg);
    setIndicator('âœ‚ CUT â†’ End');
    resolve();
    return;
  }

  const attemptNum = attemptCount + 1;

  const cutIndicator = `\n\n<span style="color:#f59e0b; font-weight:bold;">âœ‚ï¸ CUTæ¤œçŸ¥: ä¼šè©±ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ç¶šãã‚’è¦æ±‚ã—ã¾ã™... (#${attemptNum})</span>`;
  if (ansEl) ansEl.innerHTML = formatMarkdown(responseText + cutIndicator);
  setIndicator(`âœ‚ CUT â†’ Continue #${attemptNum}`);

  google.script.run.withSuccessHandler((contRaw) => {
    let contNormalized;
    if (typeof contRaw === "string") {
      try { contNormalized = JSON.parse(contRaw); }
      catch (e) { contNormalized = { status: "success", response: contRaw }; }
    } else if (typeof contRaw === "object" && contRaw !== null) {
      contNormalized = contRaw;
    } else {
      contNormalized = { status: "success", response: String(contRaw || "(ç„¡å¿œç­”)") };
    }

    const contText = contNormalized.response || contNormalized.text || contNormalized.message || String(contNormalized || "(ç„¡å¿œç­”)");
    const combinedText = responseText + '\n\n**ï¼ˆç¶šã #' + attemptNum + 'ï¼‰**\n' + contText;

    const isStillCut = _detectCut_(contText);

    if (isStillCut && attemptCount < (MAX_CUT_ATTEMPTS - 1)) {
      _handleCutContinuation_(speaker, combinedText, ctx, imgs, sessionId, title, role, id, indicatorId, attemptCount + 1, resolve);
      return;
    }

    if (ansEl) ansEl.innerHTML = formatMarkdown(combinedText);

    if (isStillCut) {
      setIndicator('âœ‚ CUT â†’ End');
    } else {
      if (indicatorEl) indicatorEl.textContent = 'âœ“ Received';
    }

    // ç¶šãåˆ†ã ã‘ctxã¸è¿½åŠ ï¼ˆæœ€åˆã¯runStepã§è¿½åŠ æ¸ˆã¿ï¼‰
    ctx.text += `[${speaker}]: ${contText}\n`;
    resolve();
  }).withFailureHandler(() => {
    const failMsg = `\n\n<span style="color:#f59e0b; font-weight:bold;">âœ‚ï¸ CUTæ¤œçŸ¥: ä¼šè©±ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã¾ã™ï¼ˆç¶šãè¦æ±‚å¤±æ•—ï¼‰</span>`;
    if (ansEl) ansEl.innerHTML = formatMarkdown(responseText + failMsg);
    setIndicator('âœ‚ CUT â†’ Failed');
    resolve();
  }).runConferenceTurn(
    speaker,
    ctx.text,
    "å‰ã®å›ç­”ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ç¶šãã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚",
    imgs,
    sessionId,
    title,
    role
  );
}

/* =========================================================
   runStep
========================================================= */
function runStep(speaker, instr, imgs, title, step, role){
  return new Promise((resolve)=>{
    updateStep(step);
    const tl = document.getElementById('timeline');
    const id = Date.now() + Math.floor(Math.random()*1000);

    let roleBadge = ""; let roleClass = "";
    if(role === 'proposer') { roleBadge='<span class="role-badge" style="background:var(--role-proposer);">ææ¡ˆ</span>'; roleClass='role-proposer'; }
    if(role === 'opposer') { roleBadge='<span class="role-badge" style="background:var(--role-opposer);">åè«–</span>'; roleClass='role-opposer'; }
    if(role === 'tech') { roleBadge='<span class="role-badge" style="background:var(--role-tech);">æŠ€è¡“</span>'; roleClass='role-tech'; }

    const displayName = normalizeDisplayName(speaker, role);
    const indicatorId = `indicator-${id}`;

    const indicatorText = settings?.indicators?.thinking ? 'Thinking...' : '';
    tl.insertAdjacentHTML('beforeend',
      `<div class="timeline-card ${roleClass}">
        <div class="tl-header h-${speaker}">
          <span>${displayName} ${roleBadge}</span>
          <span id="${indicatorId}">${indicatorText}</span>
        </div>
        <div class="tl-body" id="ans-${id}"><div class="loader">...</div></div>
      </div>`
    );
    window.scrollTo(0, document.body.scrollHeight);

    const ctx = { text: (typeof context === 'string' ? context : String(context || "")) };

    const ansEl = document.getElementById(`ans-${id}`);
    const indicatorEl = document.getElementById(indicatorId);

    const setIndicator = (txt, kind) => {
      if (!indicatorEl) return;

      if (kind === 'timeout' && !settings?.indicators?.timeout) return;
      if (kind === 'late'    && !settings?.indicators?.late)    return;
      if (kind === 'error'   && !settings?.indicators?.error)   return;
      if (kind === 'cut'     && !settings?.indicators?.cut)     return;

      if (kind === 'received') {
        indicatorEl.textContent = txt;
        return;
      }
      indicatorEl.textContent = txt;
    };

    const finalize = () => {
      context = ctx.text;
      resolve();
    };

    const WATCHDOG_MS = 60000;
    let done = false;
    let retryCount = 0;
    const MAX_RETRY = 10;
    let retryTimer = null;

    const timer = setTimeout(() => {
      if (done) return;
      done = true;

      const msg = `(â± ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${WATCHDOG_MS/1000}ç§’ å¿œç­”ãªã— â†’ æ¬¡ã¸é€²ã¿ã¾ã™)`;
      if (ansEl) ansEl.innerHTML = `<span style="color:#b45309; font-weight:bold;">${msg}</span>`;
      setIndicator('â± Timeout (move on)', 'timeout');

      ctx.text += `[${speaker}]: ${msg}\n`;
      finalize();

      retryTimer = setInterval(() => {
        if (retryCount >= MAX_RETRY) {
          if (retryTimer) clearInterval(retryTimer);
          return;
        }
        retryCount++;

        google.script.run.withSuccessHandler((logs) => {
          if (!Array.isArray(logs) || logs.length === 0) return;

          const lastLog = logs[logs.length - 1];
          if (lastLog && lastLog.speaker === speaker && lastLog.content) {
            const already = (ansEl && ansEl.innerHTML && ansEl.innerHTML.includes(lastLog.content));
            if (ansEl && !already) {
              ansEl.innerHTML = `<span style="color:#10b981; font-weight:bold;">(é…å»¶ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—)</span><br>` + formatMarkdown(lastLog.content);
              setIndicator('â†» Late response fetched', 'late');

              ctx.text += `[${speaker}]: ${lastLog.content}\n`;
              context = ctx.text;

              if (retryTimer) clearInterval(retryTimer);
            }
          }
        }).getSessionLogs(sessionId);
      }, 30000);

    }, WATCHDOG_MS);

    google.script.run.withSuccessHandler(raw => {
      if (done) {
        if (retryTimer) clearInterval(retryTimer);
        return;
      }
      done = true;
      clearTimeout(timer);
      if (retryTimer) clearInterval(retryTimer);

      let normalized = null;
      if (typeof raw === "string") {
        try { normalized = JSON.parse(raw); }
        catch (e) { normalized = { status: "success", response: raw }; }
      } else if (typeof raw === "object" && raw !== null) {
        normalized = raw;
      } else {
        normalized = { status: "success", response: String(raw || "(ç„¡å¿œç­”)") };
      }

      const responseText = normalized.response || normalized.text || normalized.message || String(normalized || "(ç„¡å¿œç­”)");
      setIndicator('âœ“ Received', 'received');

      // æœ€åˆã®å¿œç­”ã¯ã“ã“ã§1å›ã ã‘ctxã«è¿½åŠ 
      ctx.text += `[${speaker}]: ${responseText}\n`;

      const isCut = _detectCut_(responseText);
      const autoContinueEnabled = true;

      if (ansEl) ansEl.innerHTML = formatMarkdown(responseText);

      if (isCut && autoContinueEnabled) {
        _handleCutContinuation_(speaker, responseText, ctx, imgs, sessionId, title, role, id, indicatorId, 0, () => {
          finalize();
        });
        return;
      }

      finalize();
    }).withFailureHandler(err => {
      if (done) {
        if (retryTimer) clearInterval(retryTimer);
        return;
      }
      done = true;
      clearTimeout(timer);
      if (retryTimer) clearInterval(retryTimer);

      const errorText = `(ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼)\n${err?.message || err}`;
      if (ansEl) ansEl.innerHTML = `<span style="color:red;">${formatMarkdown(errorText)}</span>`;
      setIndicator('âš  Error', 'error');

      ctx.text += `[${speaker}]: ${errorText}\n`;
      finalize();
    }).runConferenceTurn(speaker, ctx.text, instr, imgs, sessionId, title, role);
  });
}

/* =========================================================
   ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆMCå¹²æ¸‰æ’é™¤ï¼‹é€²æ—ãƒãƒ¼è¡¨ç¤ºï¼‰
========================================================= */
function startManual(theme) {
  const grid = document.getElementById('manualGrid');
  grid.style.display = 'grid'; 
  grid.innerHTML = "";
  
  // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã¯ã€ŒmcSelectã€ã¯ä½¿ã‚ãªã„ï¼ˆå¹²æ¸‰æ’é™¤ï¼‰
  const targets = (selected.length > 0 ? selected : AGENTS);

  // é€²æ—ï¼šä¸¦åˆ—ãªã®ã§ 1â†’å®Œäº†ã®2æ®µæ‰±ã„ï¼ˆè¦‹ãˆã‚‹åŒ–ï¼‰
  buildProgressBar(2);
  updateStep(1);

  const cols = Math.min(targets.length, 4);
  grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  const title = document.getElementById('topicTitle').value || "";
  const imgs = [...imagesBase64];

  // æœ«å°¾ãƒãƒ¼ã‚«ãƒ¼æŒ‡ç¤º
  const endMarker = "å¿…ãšå›ç­”ã®æœ€å¾Œã‚’ã€Œä»¥ä¸Šã€‚ã€ã§çµ‚ãˆã¦ãã ã•ã„ã€‚é€”ä¸­ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«æœ€å¾Œã¾ã§æ›¸ãåˆ‡ã£ã¦ãã ã•ã„ã€‚";
  const instr = _applySettingsToInstruction_(theme + "\n" + endMarker);

  let completed = 0;

  targets.forEach(a => {
    const div = document.createElement('div'); div.className = 'mini-col';
    const id = `hist-${a}-${Date.now()}-${Math.floor(Math.random()*1000)}`;
    const displayName = normalizeDisplayName(a, null);
    div.innerHTML = `<div class="mini-head h-${a}">${displayName}</div><div class="mini-body" id="${id}"><div style="color:#999;">Thinking...</div></div>`;
    grid.appendChild(div);

    google.script.run.withSuccessHandler(raw => {
      let normalized = null;
      if (typeof raw === "string") {
        try { normalized = JSON.parse(raw); } catch (e) { normalized = { status: "success", response: raw }; }
      } else if (typeof raw === "object" && raw !== null) {
        normalized = raw;
      } else {
        normalized = { status: "success", response: String(raw || "(ç„¡å¿œç­”)") };
      }
      const responseText = normalized.response || normalized.text || normalized.message || String(normalized || "(ç„¡å¿œç­”)");
      document.getElementById(id).innerHTML = formatMarkdown(responseText);

      completed++;
      if (completed >= targets.length) {
        updateStep(2);
        document.getElementById('statusText').innerText = "âœ… å®Œäº†";
        document.getElementById('statusText').style.color = '#10b981';
        saveStorage();
      }
    }).withFailureHandler(err=>{
      document.getElementById(id).innerHTML = `<span style="color:#ef4444;">(ã‚¨ãƒ©ãƒ¼) ${err?.message || err}</span>`;
      completed++;
      if (completed >= targets.length) {
        updateStep(2);
        document.getElementById('statusText').innerText = "âœ… å®Œäº†ï¼ˆã‚¨ãƒ©ãƒ¼ã‚ã‚Šï¼‰";
        document.getElementById('statusText').style.color = '#ef4444';
        saveStorage();
      }
    }).runConferenceTurn(a, theme, instr, imgs, sessionId, title, null);
  });
}

/* =========================================================
   ã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
========================================================= */
function openCode(i) {
  const s = codeSnippets[i]; 
  const el = document.getElementById('codeViewerContent');
  el.textContent = s.c; 
  el.className = `language-${s.l}`; 
  if (typeof hljs !== 'undefined' && hljs) hljs.highlightElement(el);
  openModal('codeModal');
}
function copyCode() { 
  const el = document.getElementById('codeViewerContent');
  if (el) navigator.clipboard.writeText(el.textContent).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")); 
}
function uploadCode(){
  const c = document.getElementById('themeInput').value;
  if(c) google.script.run.withSuccessHandler(alert).uploadToGithub(prompt("File?","Code.gs"),c);
}

/* =========================================================
   Image Handling
========================================================= */
async function handleFileSelect(e){
  const f = Array.from(e.target.files);
  for(const x of f){
    const c = await compress(x);
    if (c) {
      imagesBase64.push(c);
      const wrapper = document.createElement('div');
      wrapper.className = 'preview-wrapper';
      wrapper.innerHTML = `<img src="${c}" class="preview-thumb"><div class="preview-popup"><img src="${c}"></div>`;
      document.getElementById('previewArea').appendChild(wrapper);
    }
  }
}
function compress(b){
  return new Promise(r=>{
    const f = new FileReader();
    f.onload = e => {
      const i = new Image();
      i.onload = () => {
        const c = document.createElement('canvas');
        let w = i.width, h = i.height;
        if(w > 1000 || h > 1000) {
          const s = Math.min(1000/w, 1000/h);
          w *= s; h *= s;
        }
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(i, 0, 0, w, h);
        r(c.toDataURL('image/jpeg', 0.7));
      };
      i.src = e.target.result;
    };
    f.readAsDataURL(b);
  });
}
async function pasteFromClipboard(){
  try {
    const i = await navigator.clipboard.read();
    for(const x of i){
      const t = x.types.find(a => a.startsWith('image/'));
      if(t){
        const b = await x.getType(t);
        const c = await compress(b);
        if (c) {
          imagesBase64.push(c);
          const w = document.createElement('div');
          w.className = 'preview-wrapper';
          w.innerHTML = `<img src="${c}" class="preview-thumb"><div class="preview-popup"><img src="${c}"></div>`;
          document.getElementById('previewArea').appendChild(w);
        }
      }
    }
  } catch (e) {
    console.warn('Clipboard read failed:', e);
  }
}

/* =========================================================
   ä¿å­˜/å¾©å…ƒï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è­°é¡Œã‚‚å¾©å…ƒï¼‰
========================================================= */
function _saveMeta_(){
  try {
    const meta = {
      topicTitle: document.getElementById('topicTitle')?.value || "",
      themeInput: document.getElementById('themeInput')?.value || "",
      sessionId: sessionId,
      savedAt: Date.now()
    };
    localStorage.setItem(STORAGE_META_KEY, JSON.stringify(meta));
  } catch (e) {
    console.warn('save meta failed:', e);
  }
}

function saveStorage(){
  try {
    localStorage.setItem(STORAGE_KEY, document.getElementById('mainStage').innerHTML);
    _saveMeta_();
  } catch (e) {
    console.warn('saveStorage failed:', e);
  }
}

function restoreFromStorage(){
  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å¾©å…ƒï¼ˆå¾“æ¥äº’æ›ï¼‰
  try {
    const html = localStorage.getItem(STORAGE_KEY);
    if (html) {
      document.getElementById('mainStage').innerHTML = html;
      document.getElementById('mainStage').style.display = 'block';
    }
  } catch (e) {}

  // ã‚¿ã‚¤ãƒˆãƒ«/è­°é¡Œå¾©å…ƒ
  try {
    const metaRaw = localStorage.getItem(STORAGE_META_KEY);
    if (metaRaw) {
      const meta = JSON.parse(metaRaw);
      if (meta && typeof meta === 'object') {
        if (document.getElementById('topicTitle') && typeof meta.topicTitle === 'string') {
          document.getElementById('topicTitle').value = meta.topicTitle;
        }
        if (document.getElementById('themeInput') && typeof meta.themeInput === 'string') {
          document.getElementById('themeInput').value = meta.themeInput;
        }
        if (meta.sessionId) sessionId = meta.sessionId; // åŒä¸€sessionã®å†å–å¾—ã«å¯„ã›ã‚‹
      }
    }
  } catch (e) {
    console.warn('restore meta failed:', e);
  }
}

/* =========================================================
   å±¥æ­´
========================================================= */
function openHistoryModal(){
  openModal('historyModal');
  google.script.run.withSuccessHandler(l=>{
    let list = l;
    if (typeof l === "string") {
      try { list = JSON.parse(l); } catch (e) { list = []; }
    }
    if (!Array.isArray(list)) list = [];
    
    if (!list.length) {
      document.getElementById('logList').innerHTML = "<div style='padding:20px;text-align:center;color:#64748b;'>ä¿å­˜æ¸ˆã¿ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
      return;
    }
    
    document.getElementById('logList').innerHTML = list.map(x=>`<div class="log-item"><div class="log-text" onclick="loadLog('${x.id}')">${x.time || ''} ${x.title||'(ç„¡é¡Œ)'}</div><button class="log-del-btn" onclick="deleteLog('${x.id}',this)">å‰Šé™¤</button></div>`).join('');
  }).withFailureHandler(err=>{
    document.getElementById('logList').innerHTML = `<div style='padding:20px;text-align:center;color:#ef4444;'>å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${err?.message || err}</div>`;
  }).getLogList();
}
function closeHistoryModal(){ closeModal('historyModal'); }

// è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
function openSettingsModal() { applySettingsToUI(); openModal('settingsModal'); }
function closeSettingsModal() { closeModal('settingsModal'); }

function applySettingsToUI() {
  document.getElementById('settingSummaryLevel').value = settings.summaryLevel;
  document.getElementById('settingConversationTone').value = settings.conversationTone;
  document.getElementById('settingPoliteSuppress').checked = settings.politeSuppress;
  document.getElementById('indicatorThinking').checked = settings.indicators.thinking;
  document.getElementById('indicatorTimeout').checked = settings.indicators.timeout;
  document.getElementById('indicatorCut').checked = settings.indicators.cut;
  document.getElementById('indicatorLate').checked = settings.indicators.late;
  document.getElementById('indicatorError').checked = settings.indicators.error;
}

function saveSettingsAndClose() {
  settings.summaryLevel = document.getElementById('settingSummaryLevel').value;
  settings.conversationTone = document.getElementById('settingConversationTone').value;
  settings.politeSuppress = document.getElementById('settingPoliteSuppress').checked;
  settings.indicators.thinking = document.getElementById('indicatorThinking').checked;
  settings.indicators.timeout = document.getElementById('indicatorTimeout').checked;
  settings.indicators.cut = document.getElementById('indicatorCut').checked;
  settings.indicators.late = document.getElementById('indicatorLate').checked;
  settings.indicators.error = document.getElementById('indicatorError').checked;
  saveSettings();
  closeSettingsModal();
}

function _applySettingsToInstruction_(baseInstr) {
  let tags = [];
  if (settings.summaryLevel === 'simple') tags.push('[è¦ç´„:ç°¡å˜] çµè«–â†’ç®‡æ¡æ›¸ã3ã¤â†’æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³');
  else if (settings.summaryLevel === 'standard') tags.push('[è¦ç´„:æ¨™æº–] çµè«–â†’ç†ç”±â†’æ‰‹é †');
  else if (settings.summaryLevel === 'detailed') tags.push('[è¦ç´„:è©³ç´°] å‰æâ†’åˆ¤æ–­â†’æ‰‹é †â†’æ³¨æ„ç‚¹');

  if (settings.conversationTone === 'first') tags.push('[ãƒˆãƒ¼ãƒ³:åˆã‚ã¦] ä¸å¯§ã‚');
  else if (settings.conversationTone === 'friendly') tags.push('[ãƒˆãƒ¼ãƒ³:ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼] æŸ”ã‚‰ã‹ã‚ï¼ˆç •ã‘ã™ãç¦æ­¢ï¼‰');
  else if (settings.conversationTone === 'business') tags.push('[ãƒˆãƒ¼ãƒ³:ä»•äº‹] ç”¨ä»¶ä¸­å¿ƒã§çŸ­ã');

  if (settings.politeSuppress) tags.push('[ä¸å¯§æŠ‘åˆ¶ON] å‰ç½®ããƒ»æŒ¨æ‹¶ã‚’å‰Šã‚‹');

  if (tags.length > 0) return baseInstr + '\n\nã€é‹ç”¨ã‚¿ã‚°ã€‘\n' + tags.join('\n');
  return baseInstr;
}

function loadLog(sessionId){
  if(!sessionId) return;
  if(!confirm("éå»ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ")) return;
  
  closeHistoryModal();
  
  google.script.run
    .withSuccessHandler((logs) => {
      let arr = logs;
      if (typeof logs === "string") {
        try { arr = JSON.parse(logs); } catch (e) { arr = []; }
      }
      if (!Array.isArray(arr)) arr = [];
      
      if (arr.length === 0) {
        alert("ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      
      const tl = document.getElementById('timeline');
      if (!tl) {
        alert("ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
      }
      
      tl.innerHTML = "";
      
      arr.forEach((log) => {
        const speaker = String(log.speaker || "unknown");
        const content = String(log.content || "");
        const time = String(log.time || "");
        
        const displayName = normalizeDisplayName(speaker, null);
        
        let roleBadge = "";
        let roleClass = "";
        const lowerSpeaker = speaker.toLowerCase();
        if (lowerSpeaker.includes('proposer') || assignedRoles[speaker] === 'proposer') {
          roleBadge = '<span class="role-badge" style="background:var(--role-proposer);">ææ¡ˆ</span>';
          roleClass = 'role-proposer';
        } else if (lowerSpeaker.includes('opposer') || assignedRoles[speaker] === 'opposer') {
          roleBadge = '<span class="role-badge" style="background:var(--role-opposer);">åè«–</span>';
          roleClass = 'role-opposer';
        } else if (lowerSpeaker.includes('tech') || assignedRoles[speaker] === 'tech') {
          roleBadge = '<span class="role-badge" style="background:var(--role-tech);">æŠ€è¡“</span>';
          roleClass = 'role-tech';
        } else if (lowerSpeaker === 'yui' || lowerSpeaker.includes('mc')) {
          roleBadge = '<span class="role-badge" style="background:#64748b;">å¸ä¼š</span>';
        }
        
        const card = document.createElement('div');
        card.className = `timeline-card ${roleClass}`;
        card.innerHTML = `
          <div class="tl-header h-${speaker.toLowerCase()}">
            <span>${displayName} ${roleBadge}</span>
            <span>${time}</span>
          </div>
          <div class="tl-body">${formatMarkdown(content)}</div>
        `;
        tl.appendChild(card);
      });
      
      document.getElementById('mainStage').style.display = 'block';
      document.getElementById('progressZone').style.display = 'none';
      
      window.scrollTo(0, document.body.scrollHeight);
      
      document.getElementById('statusText').innerText = "éå»ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ";
      document.getElementById('statusText').style.color = '#10b981';
    })
    .withFailureHandler((err) => {
      alert("ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: " + (err?.message || err));
    })
    .getSessionLogs(sessionId);
}

function deleteLog(id, btn){
  if(!id) return;
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  google.script.run.withSuccessHandler(r=>{
    if(r.success && btn) btn.parentElement.remove();
  }).deleteLog(id);
}
</script>
</body>
</html>
