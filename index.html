<!--
  APP: AI Strategy Room (AIä¼šè­°å®¤)
  FILE: index.html
  VERSION: v17.0.7-upload-btndead
  DATE(JST): 2026-01-21 13:48:00 JST
  SERIAL: 2026-01-21_1348_airoom-upload-btndead
  TITLE: ãƒœã‚¿ãƒ³ä¸å‹•ã®åŸå› åˆ‡ã‚Šåˆ†ã‘å¼·åŒ–ï¼ˆVERSION/BUILDè¡¨ç¤ºå¼·åŒ–ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ‡ãƒãƒƒã‚°å¼·åŒ–ï¼‰
  CHANGES:
  - ã€v17.0.7-upload-btndeadã€‘VERSION/BUILDã‚’ç¢ºå®Ÿã«è¡¨ç¤ºï¼ˆdebug=1æ™‚ã«ç”»é¢ãƒ»ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸¡æ–¹ã«å‡ºåŠ›ï¼‰
  - ã€v17.0.7-upload-btndeadã€‘ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®çµã³ã¤ãã‚’è©³ç´°ãƒ‡ãƒãƒƒã‚°ï¼ˆdebug=1æ™‚ã«console.tableã§ä¸€è¦§è¡¨ç¤ºï¼‰
  - ã€v17.0.7-upload-btndeadã€‘__bindOnclickCompat__åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢å†…ãƒ­ã‚°ã«è¡¨ç¤º
  - ã€v17.0.7-upload-btndeadã€‘debug=1æ™‚ã®ã¿ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒªã‚¹ãƒŠãƒ¼è¿½åŠ ï¼ˆé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ»pointer-eventsãƒ»z-indexæ¤œå‡ºï¼‰
  - ã€v17.0.7-upload-btndeadã€‘ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ä¾‹å¤–ã‚’ç”»é¢å†…ãƒ­ã‚°ã«è¡¨ç¤ºï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸è¦ï¼‰
  - ã€v17.0.7-upload-btndeadã€‘document.elementFromPoint(x,y)ã§è¢«ã›è¦ç´ ã‚’è©³ç´°æ¤œå‡º
  - ã€v17.0.6-btndead1ã€‘onclickäº’æ›ãƒ¬ã‚¤ãƒ¤å®Ÿè£…ï¼ˆevalç¦æ­¢ãƒ»æ­£è¦è¡¨ç¾ã§é–¢æ•°å‘¼ã³å‡ºã—ã‚’è§£æï¼‰
  - ã€v17.0.6-btndead1ã€‘__bindOnclickCompat__()ã§onclickå±æ€§ã‚’removeã—ã¦addEventListenerã§ä»˜ã‘ç›´ã™ï¼ˆUIå·®åˆ†ã‚¼ãƒ­ï¼‰
  - ã€v17.0.6-btndead1ã€‘__invokeOnclickString__()ã§é–¢æ•°å‘¼ã³å‡ºã—ã‚’å®‰å…¨ã«å®Ÿè¡Œï¼ˆæ–‡å­—åˆ—/æ•°å€¤/true/false/null/undefinedã®ã¿å¯¾å¿œï¼‰
  - ã€v17.0.6-btndead1ã€‘å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹è¦ç´ ã«ã‚‚å¯¾å¿œï¼ˆç”Ÿæˆå¾Œã«__bindOnclickCompat__()ã‚’å‘¼ã³å‡ºã—ï¼‰
  - ã€v17.0.6-btndead1ã€‘debug=1æ™‚ã«onclickäº’æ›ãƒ¬ã‚¤ãƒ¤ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºï¼ˆãƒã‚¤ãƒ³ãƒ‰æ•°/æœ€å¾Œã®ã‚¯ãƒªãƒƒã‚¯/ã‚¨ãƒ©ãƒ¼ï¼‰
  - ã€v17.0.4-btnfix3ã€‘GASå´ã®doGetã‚’ä¿®æ­£ï¼šHtmlOutputã‚’å†ç”Ÿæˆã›ãšã«è¿”ã™ï¼ˆsandbox/å®Ÿè¡Œç’°å¢ƒã‚’ä¿æŒï¼‰
  - ã€v17.0.4-btnfix3ã€‘sandbox(IFRAME)ã‚’æ˜ç¤ºã—ã¦ã€ES6ã®è§£æã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢
  - ã€v17.0.0ã€‘ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿2ç¨®è¿½åŠ : ãƒ‰ãƒƒãƒˆæ–¹å¼ï¼ˆâ—ã§çŠ¶æ…‹è¡¨ç¤ºï¼‰ãƒ»ãƒãƒ¼æ–¹å¼ï¼ˆé€²æ—ãƒãƒ¼ï¼‰ã‚’å®Ÿè£…ã€è¨­å®šã‹ã‚‰æ–¹å¼é¸æŠå¯èƒ½
  - ã€v17.0.0ã€‘ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šç™ºè¨€é‡ã‚’ã€Œç°¡å˜/æ¨™æº–/è©³ç´°ã€ã§åˆ‡ã‚Šæ›¿ãˆï¼ˆæ—¢å­˜ã®summaryLevelã‚’æ´»ç”¨ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ«å°¾ã«æ˜ç¢ºã«åæ˜ ï¼‰
  - ã€v17.0.0ã€‘ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼šè¿½è³ªå•æ©Ÿèƒ½ã‚’å®Ÿè£…ï¼ˆã‚«ãƒ¼ãƒ‰ã«è¿½è³ªå•ãƒœã‚¿ãƒ³è¿½åŠ ã€é€ä¿¡å…ˆè‡ªå‹•å›ºå®šã€å¼•ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬è‡ªå‹•æŒ¿å…¥ï¼‰
  - ã€v17.0.0ã€‘ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼šé€ä¿¡å…ˆé¸æŠUIã‚’å¾©æ´»ãƒ»å¼·åŒ–ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œã€å…¨å“¡/è§£é™¤ãƒœã‚¿ãƒ³ã€å‰å›é¸æŠä¿æŒï¼‰
  - ã€v17.0.0ã€‘å‘½åãƒ«ãƒ¼ãƒ«ï¼šAlpha/Betaç­‰ã‚’å»ƒæ­¢ã€å›ºå®šåã®ã¿ï¼ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åãƒ™ãƒ¼ã‚¹ã§å›ºå®šã€å‹æ‰‹ãªå¤‰åç¦æ­¢ï¼‰
  - ã€v17.0.0ã€‘éå»ãƒ­ã‚°å¾©å…ƒï¼šè­°é¡Œ/ã‚¿ã‚¤ãƒˆãƒ«/ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã‚‚å¾©å…ƒï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒæ™‚ã«å®Œå…¨ã«æˆ»ã‚‹ï¼‰
  - ã€é‡è¦ã€‘UIåŸå‰‡å›ºå®š: è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®é …ç›®è¿½åŠ ã€ã‚«ãƒ¼ãƒ‰å†…ã®æœ€å°ãƒœã‚¿ãƒ³è¿½åŠ ã¯è¨±å¯
  - å‰å›ã®v16.3.8-hf1-fullã®æ©Ÿèƒ½ã¯å…¨ã¦ç¶­æŒï¼ˆCUTæ¤œçŸ¥ãƒ»è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ç­‰ï¼‰
  AUTHOR: Rex
  BUILD_PARAM: ?b=2026-01-21_1348_airoom-upload-btndead
  DEBUG_PARAM: &debug=1
  REPO: wit-ai-apps/wit-ai-strategy-room
-->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Round Table v17.0.7-upload-btndead</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(typeof pdfjsLib!=='undefined')pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
  :root { 
    --bg-color: #f0f2f5; --card-bg: #ffffff; --text-main: #333; 
    --shadow-btn: 0 4px 6px rgba(0,0,0,0.1);
    
    /* AI Theme Colors */
    --col-yui: #ec4899; --col-gemini: #8b5cf6; --col-rex: #f59e0b;
    --col-deepseek: #3b82f6; --col-llama: #06b6d4; --col-qwen: #84cc16;
    --col-mistral: #a855f7; --col-dolphin: #ef4444;
    
    /* Role Colors */
    --role-proposer: #3b82f6;
    --role-opposer: #ef4444;
    --role-tech: #eab308;
    --role-observer: #94a3b8;
  }

  body { background-color: var(--bg-color); font-family: 'Helvetica Neue', Arial, sans-serif; color: var(--text-main); margin: 0; padding: 20px; font-size: 16px; transition: font-size 0.2s; }
  .container { max-width: 1400px; margin: 0 auto; }
  .card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); padding: 24px; margin-bottom: 24px; border: 1px solid #e5e7eb; }

  /* Header */
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
  .app-title { font-size: 1.5rem; font-weight: 800; color: #1f2937; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
  .app-meta { font-size: 0.75rem; color: #64748b; font-weight: normal; margin-top: 4px; background: #e2e8f0; padding: 2px 8px; border-radius: 4px; display: inline-block; width: fit-content; }

  /* Buttons & Inputs */
  .btn, .mode-btn, .agent-badge { box-shadow: var(--shadow-btn); transition: 0.2s; cursor: pointer; font-weight: bold; border: none; }
  .btn:active, .mode-btn:active, .agent-badge:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .btn { padding: 0 20px; height: 44px; border-radius: 22px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.95rem; }
  .btn-secondary { background: #fff; border: 1px solid #cbd5e1; color: #475569; }
  .btn-secondary:hover { background: #f8fafc; border-color: #94a3b8; }
  .btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; }
  .btn-primary:hover { filter: brightness(1.1); }
  .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
  .btn-danger:hover { filter: brightness(1.1); }
  
  .title-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.1rem; box-sizing: border-box; }
  textarea { width: 100%; height: 150px; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; resize: vertical; box-sizing: border-box; font-family: monospace; }
  textarea:focus { border-color: #10b981; outline: none; background: #f0fdf4; }

  /* Settings Area */
  .settings-area { display: none; background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin-top: 15px; animation: fadeIn 0.3s; }
  .control-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
  .mode-switch { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; }
  .mode-btn { flex: 1; max-width: 200px; height: 50px; border: 2px solid #e2e8f0; background: #fff; color: #94a3b8; font-size: 1rem; border-radius: 25px; }
  .mode-btn.active { border-color: #10b981; color: #fff; background: linear-gradient(135deg, #10b981, #059669); }
  
  .badge-zone { flex-grow: 1; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .agent-badge { padding: 10px 18px; border-radius: 25px; background: #fff; border: 2px solid transparent; color: #64748b; font-size: 0.9rem; }
  .agent-badge.selected { color: white; }
  /* Agent Colors */
  [data-agent="yui"].selected { background: var(--col-yui); }
  [data-agent="gemini"].selected { background: var(--col-gemini); }
  [data-agent="rex"].selected { background: var(--col-rex); }
  [data-agent="deepseek"].selected { background: var(--col-deepseek); }
  [data-agent="llama"].selected { background: var(--col-llama); }
  [data-agent="qwen"].selected { background: var(--col-qwen); }
  [data-agent="mistral"].selected { background: var(--col-mistral); }
  [data-agent="dolphin"].selected { background: var(--col-dolphin); }

  /* â˜…ç”»åƒãƒ›ãƒãƒ¼æ‹¡å¤§ (Wikipediaé¢¨ãƒ»å·¨å¤§åŒ–ç‰ˆ)â˜… */
  .preview-wrapper { position: relative; display: inline-block; margin-right: 8px; margin-bottom: 8px; }
  .preview-thumb { height: 50px; border-radius: 4px; border: 2px solid #cbd5e1; cursor: pointer; transition: 0.2s; background: white; object-fit: cover; }
  .preview-thumb:hover { border-color: #10b981; transform: scale(1.05); }
  
  .preview-popup {
    display: none;
    position: absolute;
    bottom: 60px;
    left: 0;
    width: 400px; /* â˜…å…ƒã®å€¤ã«æˆ»ã™ï¼ˆUIå‡çµï¼‰ */
    max-width: 80vw;
    background: white;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    border: 1px solid #cbd5e1;
    z-index: 9999;
    animation: fadeIn 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28);
  }
  .preview-popup img { width: 100%; height: auto; border-radius: 8px; display: block; }
  .preview-wrapper:hover .preview-popup { display: block; }
  .preview-popup::after {
    content: ""; position: absolute; top: 100%; left: 20px;
    border-width: 10px; border-style: solid; border-color: white transparent transparent transparent;
  }

  /* Log List Styles */
  .log-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #e2e8f0; background: #fff; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f1f5f9; }
  .log-item:hover { background: #f8fafc; border-color: #cbd5e1; }
  .log-text { cursor: pointer; flex-grow: 1; color: #334155; font-weight: bold; font-size: 0.95rem; }
  .log-text:hover { color: #2563eb; }
  .log-del-btn { background: #ef4444; color: white; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; font-weight: bold; border: none; }
  .log-del-btn:hover { background: #dc2626; }

  /* Timeline & Cards */
  .main-stage { display: none; margin-top: 20px; }
  .timeline { display: flex; flex-direction: column; gap: 20px; }
  .timeline-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid #eee; border-left: 5px solid transparent; transition: 0.3s; position: relative; }
  .tl-header { padding: 10px 15px; font-size: 0.9rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  .tl-body { padding: 15px 20px; font-size: 1rem; line-height: 1.7; color: #333; }
  
  /* â˜…v17.0.0è¿½åŠ ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ–¹å¼ï¼ˆãƒ‰ãƒƒãƒˆæ–¹å¼ï¼‰â˜… */
  .indicator-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: 6px; vertical-align: middle; }
  .indicator-dot.waiting { background: #94a3b8; }
  .indicator-dot.sending { background: #3b82f6; animation: pulse 1.5s infinite; }
  .indicator-dot.receiving { background: #10b981; animation: pulse 1.5s infinite; }
  .indicator-dot.completed { background: #10b981; }
  .indicator-dot.error { background: #ef4444; }
  
  /* â˜…v17.0.0è¿½åŠ ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ–¹å¼ï¼ˆãƒãƒ¼æ–¹å¼ï¼‰â˜… */
  .indicator-bar { position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #e2e8f0; overflow: hidden; }
  .indicator-bar-progress { height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); width: 0%; transition: width 0.3s; }
  .indicator-bar.waiting .indicator-bar-progress { width: 0%; background: #94a3b8; }
  .indicator-bar.sending .indicator-bar-progress { width: 30%; background: #3b82f6; animation: progress 2s infinite; }
  .indicator-bar.receiving .indicator-bar-progress { width: 70%; background: #10b981; animation: progress 2s infinite; }
  .indicator-bar.completed .indicator-bar-progress { width: 100%; background: #10b981; }
  .indicator-bar.error .indicator-bar-progress { width: 100%; background: #ef4444; }
  
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  
  .role-proposer { border-color: var(--role-proposer); }
  .role-opposer { border-color: var(--role-opposer); }
  .role-tech { border-color: var(--role-tech); }
  .role-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; color: #fff; margin-left: 8px; vertical-align: middle; }
  
  .manual-grid { display: none; grid-template-columns: repeat(4, 1fr); gap: 16px; }
  @media (max-width: 1000px) { .manual-grid { grid-template-columns: repeat(2, 1fr); } }
  .mini-col { height: 500px; display: flex; flex-direction: column; background: #fff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
  .mini-head { padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
  .mini-body { overflow-y: auto; flex: 1; padding: 10px; }
  /* â˜…v17.0.0è¿½åŠ ï¼šè¿½è³ªå•ãƒœã‚¿ãƒ³â˜… */
  .followup-btn { background: #3b82f6; color: white; border: none; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; font-weight: bold; }
  .followup-btn:hover { background: #2563eb; }
  
  /* â˜…v17.0.0è¿½åŠ ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€ä¿¡å…ˆé¸æŠUIâ˜… */
  .manual-send-area { display: none; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 15px; }
  .manual-send-targets { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
  .manual-send-target-badge { padding: 6px 12px; border-radius: 20px; background: #fff; border: 2px solid #cbd5e1; color: #64748b; font-size: 0.85rem; cursor: pointer; }
  .manual-send-target-badge.selected { background: #3b82f6; color: white; border-color: #3b82f6; }
  .manual-send-actions { display: flex; gap: 8px; }
  
  /* Utilities */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(3px); }
  .modal-content { background: #fff; width: 90%; max-width: 800px; max-height: 80vh; border-radius: 16px; padding: 25px; display: flex; flex-direction: column; }
  .font-ctrl-group { display: flex; background: #fff; border-radius: 20px; padding: 3px; border: 1px solid #cbd5e1; }
  .font-btn { border: none; background: transparent; padding: 5px 12px; cursor: pointer; font-size: 0.8rem; color: #64748b; border-radius: 16px; }
  .font-btn.active { background: #334155; color: #fff; }
  .code-link-btn { display: inline-block; background: #1e293b; color: #fff; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-family: monospace; font-size: 0.85rem; cursor: pointer; margin: 8px 0; border: none; }
  .code-modal-content { width: 95%; max-width: 1200px; height: 90vh; background: #1e1e1e; color: #fff; padding: 0; }
  .code-modal-body { flex: 1; overflow: auto; padding: 20px; }
  
  /* Progress */
  .progress-zone { max-width: 1400px; margin: 20px auto; padding: 20px; background: rgba(255,255,255,0.95); border-radius: 16px; display: none; border: 1px solid #e5e7eb; overflow-x: auto; }
  .progress-bar { display: flex; justify-content: space-between; position: relative; min-width: 100%; }
  .progress-line { position: absolute; top: 15px; left: 0; right: 0; height: 4px; background: #e2e8f0; z-index: 0; }
  .step { position: relative; z-index: 1; text-align: center; width: 80px; flex-shrink: 0; }
  .step-dot { width: 34px; height: 34px; background: #e2e8f0; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #94a3b8; transition: 0.3s; border: 2px solid #fff; }
  .step.active .step-dot { background: #10b981; color: #fff; transform: scale(1.1); }
  .step-label { font-size: 0.75rem; color: #64748b; font-weight: bold; }
  
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div class="container" id="appContainer">
  <div class="header">
    <div style="display:flex; align-items:center; gap:10px;">
      <div class="app-title">AI Round Table <span class="app-meta">v17.0.4-btnfix3</span></div>
    </div>
    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <div class="font-ctrl-group">
        <button class="font-btn" onclick="setFontSize('small')">å°</button>
        <button class="font-btn active" onclick="setFontSize('medium')" id="btn-font-m">ä¸­</button>
        <button class="font-btn" onclick="setFontSize('large')">å¤§</button>
      </div>
      <button class="btn btn-secondary" onclick="openHistoryModal()">ğŸ“‚ ãƒ­ã‚°</button>
      <button class="btn btn-secondary" onclick="tryReset()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
      <!-- â˜…è¿½åŠ ï¼šè¨­å®šãƒœã‚¿ãƒ³ï¼ˆä¾‹å¤–è¨±å¯ï¼šUIè¿½åŠ ï¼‰â˜… -->
      <button class="btn btn-secondary" onclick="openSettingsModal()">âš™ è¨­å®š</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <div id="statusText" style="font-weight:bold; color:#10b981;">å¾…æ©Ÿä¸­...</div>
      <div id="clock" style="color:#94a3b8; font-weight:bold;"></div>
    </div>

    <input type="text" id="topicTitle" class="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: æ–°è¦äº‹æ¥­æ¡ˆã®æ¤œè¨)">
    <textarea id="themeInput" placeholder="ã“ã“ã«è­°é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
    
    <div style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px;">
      <input type="file" id="fileInput" hidden multiple onchange="handleFileSelect(event)">
      <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">ğŸ“· ç”»åƒ</button>
      <button class="btn btn-secondary" onclick="pasteFromClipboard()">ğŸ“‹ è²¼ä»˜</button>
      <button class="btn btn-secondary" onclick="insertTemplate()" style="color:#3b82f6; border-color:#3b82f6;">ğŸ“„ Codeè²¼ä»˜æ </button>
      <button class="btn btn-secondary" onclick="resetInput()">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
      <button class="btn btn-secondary" onclick="uploadCode()">ğŸ’¾ GitHub</button>
    </div>
    <div id="previewArea" style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap; min-height:10px;"></div>

    <hr style="border:0; border-top:1px solid #e2e8f0; margin:25px 0;">

    <div style="text-align:center; margin-bottom:10px; font-weight:bold; color:#64748b;">STEP 1: ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</div>
    <div class="mode-switch">
      <button id="mode-auto" class="mode-btn" onclick="setMode('auto')">ğŸ¤– ã‚ªãƒ¼ãƒˆ (å††å“ä¼šè­°)</button>
      <button id="mode-manual" class="mode-btn" onclick="setMode('manual')">ğŸ“ ãƒãƒ‹ãƒ¥ã‚¢ãƒ« (ä¸¦åˆ—)</button>
    </div>

    <div id="settingsArea" class="settings-area">
      <div style="margin-bottom:10px; font-weight:bold; color:#64748b;">STEP 2: å‚åŠ AIã¨å½¹å‰²ã®è¨­å®š</div>
      <div class="control-row">
        <div id="mcWrapper" class="mc-zone" style="margin-right:15px;">
          <label style="font-weight:bold; margin-right:5px; color:#475569;">ğŸ¤ å¸ä¼š:</label>
          <select id="mcSelect" class="mc-select"></select>
        </div>
        <div id="roundWrapper" style="display:none; margin-right:15px;">
          <label style="font-weight:bold; margin-right:5px; color:#475569;">ğŸ”„ è­°è«–:</label>
          <select id="roundSelect" class="mc-select">
            <option value="1">1ã‚¯ãƒ¼ãƒ« (å³æ±º)</option>
            <option value="2" selected>2ã‚¯ãƒ¼ãƒ« (æ·±å €)</option>
            <option value="3">3ã‚¯ãƒ¼ãƒ« (å¾¹åº•)</option>
          </select>
        </div>
        <div class="badge-zone" id="agentBadges"></div>
        <div class="start-zone">
          <button id="startBtn" class="btn btn-primary" onclick="startProcess()">ğŸš€ ä¼šè­°ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="progressZone" class="progress-zone">
    <div class="progress-bar" id="progressBarInner"></div>
  </div>

  <div id="mainStage" class="main-stage">
    <div style="font-size:1.2rem; font-weight:800; margin-bottom:15px; border-left:6px solid #333; padding-left:15px; color:#333;">ğŸ”´ LIVE TIMELINE</div>
    <div id="timeline" class="timeline"></div>
  </div>

  <div id="manualGrid" class="manual-grid"></div>
  
  <!-- â˜…v17.0.0è¿½åŠ ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€ä¿¡å…ˆé¸æŠUIâ˜… -->
  <div id="manualSendArea" class="manual-send-area">
    <div style="font-weight:bold;margin-bottom:10px;color:#64748b;">ğŸ“¤ é€ä¿¡å…ˆé¸æŠ</div>
    <div class="manual-send-targets" id="manualSendTargets"></div>
    <div class="manual-send-actions">
      <button class="btn btn-secondary" onclick="selectAllManualTargets()" style="font-size:0.85rem;padding:6px 12px;">å…¨å“¡</button>
      <button class="btn btn-secondary" onclick="clearManualTargets()" style="font-size:0.85rem;padding:6px 12px;">è§£é™¤</button>
      <button class="btn btn-primary" onclick="sendManualMessage()" style="font-size:0.85rem;padding:6px 12px;">é€ä¿¡</button>
    </div>
    <div style="margin-top:10px;font-size:0.8rem;color:#64748b;" id="manualSendLastTarget"></div>
  </div>
</div>

<div id="historyModal" class="modal-overlay"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><h2>ğŸ“‚ éå»ãƒ­ã‚°</h2><button onclick="closeHistoryModal()" class="btn btn-secondary">âœ•</button></div><div id="logList" style="overflow-y:auto;flex:1;"></div></div></div>
<div id="resetModal" class="modal-overlay"><div class="modal-content" style="max-width:400px;text-align:center;"><h3 style="margin-top:0;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</h3><p style="color:#666;">ç”»é¢ã®å†…å®¹ã¨ä¸€æ™‚ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚<br>(éå»ãƒ­ã‚°ã¯æ¶ˆãˆã¾ã›ã‚“)</p><div style="display:flex;justify-content:center;gap:10px;margin-top:20px;"><button class="btn btn-secondary" onclick="closeModal('resetModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-danger" onclick="performReset()">å®Ÿè¡Œã™ã‚‹</button></div></div></div>
<div id="codeModal" class="modal-overlay" style="z-index:3000;"><div class="modal-content code-modal-content"><div style="padding:15px;background:#2d2d2d;display:flex;justify-content:space-between;"><span style="font-weight:bold;color:#fff;">ğŸ“œ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</span><div><button class="btn btn-primary" style="height:32px;font-size:0.8rem;" onclick="copyCode()">ã‚³ãƒ”ãƒ¼</button> <button onclick="closeModal('codeModal')" class="btn btn-secondary" style="background:#444;color:#fff;border:none;">âœ•</button></div></div><div class="code-modal-body"><pre><code id="codeViewerContent"></code></pre></div></div></div>
<!-- â˜…è¿½åŠ ï¼šè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä¾‹å¤–è¨±å¯ï¼šUIè¿½åŠ ï¼‰â˜… -->
<div id="settingsModal" class="modal-overlay"><div class="modal-content" style="max-width:600px;max-height:90vh;overflow-y:auto;">
  <div style="display:flex;justify-content:space-between;margin-bottom:20px;align-items:center;">
    <h2 style="margin:0;">âš™ è¨­å®š</h2>
    <button onclick="closeSettingsModal()" class="btn btn-secondary">âœ•</button>
  </div>
  <div style="display:flex;flex-direction:column;gap:20px;">
    <!-- è¦ç´„ãƒ¬ãƒ™ãƒ« -->
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ“Š è¦ç´„ãƒ¬ãƒ™ãƒ«</label>
      <select id="settingSummaryLevel" style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.95rem;">
        <option value="simple">ç°¡å˜ï¼ˆçµè«–â†’ç®‡æ¡æ›¸ã3ã¤â†’æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰</option>
        <option value="standard" selected>æ¨™æº–ï¼ˆçµè«–â†’ç†ç”±â†’æ‰‹é †ï¼‰</option>
        <option value="detailed">è©³ç´°ï¼ˆå‰æâ†’åˆ¤æ–­â†’æ‰‹é †â†’æ³¨æ„ç‚¹ï¼‰</option>
      </select>
    </div>
    <!-- ä¼šè©±ãƒˆãƒ¼ãƒ³ -->
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ’¬ ä¼šè©±ãƒˆãƒ¼ãƒ³</label>
      <select id="settingConversationTone" style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.95rem;">
        <option value="first">åˆã‚ã¦ï¼ˆä¸å¯§ã‚ï¼‰</option>
        <option value="friendly" selected>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ï¼ˆæŸ”ã‚‰ã‹ã‚ï¼‰</option>
        <option value="business">ä»•äº‹ï¼ˆç”¨ä»¶ä¸­å¿ƒã§çŸ­ãï¼‰</option>
      </select>
    </div>
    <!-- ä¸å¯§ã™ãæŠ‘åˆ¶ -->
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;cursor:pointer;">
        <input type="checkbox" id="settingPoliteSuppress" style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
        ä¸å¯§ã™ãæŠ‘åˆ¶ï¼ˆå‰ç½®ããƒ»æŒ¨æ‹¶ã‚’å‰Šã‚‹ï¼‰
      </label>
    </div>
    <!-- â˜…v17.0.0è¿½åŠ ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ–¹å¼é¸æŠâ˜… -->
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ“Š ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿è¡¨ç¤ºæ–¹å¼</label>
      <select id="settingIndicatorMode" style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.95rem;">
        <option value="off">ã‚ªãƒ•ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰</option>
        <option value="text" selected>å¾“æ¥ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºï¼‰</option>
        <option value="dot">ãƒ‰ãƒƒãƒˆæ–¹å¼ï¼ˆâ—ã§çŠ¶æ…‹è¡¨ç¤ºï¼‰</option>
        <option value="bar">ãƒãƒ¼æ–¹å¼ï¼ˆé€²æ—ãƒãƒ¼ï¼‰</option>
      </select>
    </div>
    <!-- ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆå¾“æ¥æ–¹å¼ã®ã¿ï¼‰ -->
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ“Š ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆå¾“æ¥æ–¹å¼ã®ã¿ï¼‰</label>
      <div style="display:flex;flex-direction:column;gap:8px;padding:12px;background:#f8fafc;border-radius:8px;">
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorThinking" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          Thinkingï¼ˆæ€è€ƒä¸­ï¼‰
        </label>
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorTimeout" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          Timeoutï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
        </label>
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorCut" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          CUTï¼ˆä¼šè©±ãŒé€”ä¸­ã§åˆ‡ã‚ŒãŸï¼‰
        </label>
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorLate" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          Lateï¼ˆé…å»¶ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—ï¼‰
        </label>
        <label style="cursor:pointer;display:flex;align-items:center;">
          <input type="checkbox" id="indicatorError" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer;">
          Errorï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰
        </label>
      </div>
    </div>
    <!-- â˜…v17.0.0è¿½åŠ ï¼šå›ç­”ã®è©³ã—ã•ï¼ˆã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰â˜… -->
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ“ å›ç­”ã®è©³ã—ã•ï¼ˆã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰</label>
      <select id="settingResponseDetail" style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.95rem;">
        <option value="simple">ç°¡å˜ï¼ˆè¦ç‚¹ã®ã¿ã€ç®‡æ¡æ›¸ãä¸­å¿ƒã€çŸ­ã‚ï¼‰</option>
        <option value="standard" selected>æ¨™æº–ï¼ˆè¦ç‚¹ï¼‹ç†ç”±ï¼‹æ¬¡ã®æ‰‹ï¼‰</option>
        <option value="detailed">è©³ç´°ï¼ˆæ‰‹é †ãƒ»æ³¨æ„ç‚¹ãƒ»ä»£æ›¿æ¡ˆã¾ã§ï¼‰</option>
      </select>
    </div>
    <!-- â˜…v17.0.0è¿½åŠ ï¼šAIåã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºâ˜… -->
    <div>
      <label style="font-weight:bold;display:block;margin-bottom:8px;">ğŸ‘¤ AIè¡¨ç¤ºåã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</label>
      <div style="display:flex;flex-direction:column;gap:8px;padding:12px;background:#f8fafc;border-radius:8px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="width:80px;font-size:0.85rem;">Yui:</label>
          <input type="text" id="customName-yui" placeholder="Yuiï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" style="flex:1;padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.85rem;">
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="width:80px;font-size:0.85rem;">Gemini:</label>
          <input type="text" id="customName-gemini" placeholder="Geminiï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" style="flex:1;padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.85rem;">
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="width:80px;font-size:0.85rem;">Rex:</label>
          <input type="text" id="customName-rex" placeholder="Rexï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" style="flex:1;padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.85rem;">
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="width:80px;font-size:0.85rem;">DeepSeek:</label>
          <input type="text" id="customName-deepseek" placeholder="DeepSeekï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" style="flex:1;padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.85rem;">
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="width:80px;font-size:0.85rem;">Llama:</label>
          <input type="text" id="customName-llama" placeholder="Llamaï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" style="flex:1;padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.85rem;">
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="width:80px;font-size:0.85rem;">Qwen:</label>
          <input type="text" id="customName-qwen" placeholder="Qwenï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" style="flex:1;padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.85rem;">
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="width:80px;font-size:0.85rem;">Mistral:</label>
          <input type="text" id="customName-mistral" placeholder="Mistralï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" style="flex:1;padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.85rem;">
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="width:80px;font-size:0.85rem;">Dolphin:</label>
          <input type="text" id="customName-dolphin" placeholder="Dolphinï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" style="flex:1;padding:6px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.85rem;">
        </div>
        <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">â€» ç©ºæ¬„ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåï¼ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åï¼‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™</div>
      </div>
    </div>
  </div>
  <div style="display:flex;justify-content:center;gap:10px;margin-top:25px;">
    <button class="btn btn-secondary" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-primary" onclick="saveSettingsAndClose()">ä¿å­˜</button>
  </div>
</div></div>

<script>
          // --- BOOT MARKER ---
          window.__AI_ROOM_VERSION__ = 'v17.0.7-upload-btndead';
          window.__AI_ROOM_BUILD__ = '2026-01-21_1348_airoom-upload-btndead';
          // -------------------------------
          // â˜…v17.0.7-upload-btndead: VERSION/BUILDã‚’ç¢ºå®Ÿã«è¡¨ç¤ºï¼ˆdebug=1æ™‚ï¼‰â˜…
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('debug') === '1') {
            console.log('[AIä¼šè­°å®¤] VERSION:', window.__AI_ROOM_VERSION__, 'BUILD:', window.__AI_ROOM_BUILD__);
            // ç”»é¢ã«ã‚‚ç¢ºå®Ÿã«è¡¨ç¤ºï¼ˆdebug=1æ™‚ãƒ»DOMContentLoadedå¾Œï¼‰
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', () => {
                const banner = document.getElementById('__debugBanner');
                if (banner) {
                  banner.innerHTML = `<b>${window.__AI_ROOM_VERSION__}</b> ï½œ BUILD=${window.__AI_ROOM_BUILD__} ï½œ AUTHOR=Rex ï½œ debug=1`;
                } else {
                  // ãƒãƒŠãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ç”»é¢ä¸Šéƒ¨ã«è¡¨ç¤º
                  const debugBanner = document.createElement('div');
                  debugBanner.id = '__debugBanner';
                  debugBanner.style.cssText = 'position:fixed;left:0;right:0;top:0;z-index:99999;background:#111;color:#fff;padding:8px 10px;font:12px/1.3 system-ui;opacity:.92';
                  debugBanner.innerHTML = `<b>${window.__AI_ROOM_VERSION__}</b> ï½œ BUILD=${window.__AI_ROOM_BUILD__} ï½œ AUTHOR=Rex ï½œ debug=1`;
                  document.body.insertBefore(debugBanner, document.body.firstChild);
                  const spacer = document.createElement('div');
                  spacer.style.height = '34px';
                  document.body.insertBefore(spacer, document.body.firstChild);
                }
              });
            } else {
              // æ—¢ã«DOMContentLoadedæ¸ˆã¿ã®å ´åˆ
              const banner = document.getElementById('__debugBanner');
              if (banner) {
                banner.innerHTML = `<b>${window.__AI_ROOM_VERSION__}</b> ï½œ BUILD=${window.__AI_ROOM_BUILD__} ï½œ AUTHOR=Rex ï½œ debug=1`;
              }
            }
          }
const AGENTS = ['yui','gemini','rex','deepseek','llama','qwen','mistral','dolphin'];
let selected = ['yui','gemini','rex','deepseek'];
let currentMode = null;
let imagesBase64 = []; let context = ""; let sessionId = "SESS_"+Date.now();
let codeSnippets = [];
let assignedRoles = {};
const STORAGE_KEY = 'ai_round_v16_3_3';
const SETTINGS_STORAGE_KEY = 'ai_round_settings_v16_3_7';

// â˜…v17.0.0è¿½åŠ ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨ã®å¤‰æ•°â˜…
let manualSelectedTargets = []; // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€ä¿¡å…ˆé¸æŠ
let lastManualTarget = null; // å‰å›ã®é€ä¿¡å…ˆï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
let lastFollowupCard = null; // è¿½è³ªå•å¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰æƒ…å ±

// â˜…è¿½åŠ ï¼šè¨­å®šå€¤ï¼ˆlocalStorageã‹ã‚‰å¾©å…ƒï¼‰â˜…
let settings = {
  summaryLevel: 'standard', // 'simple' / 'standard' / 'detailed'
  conversationTone: 'friendly', // 'first' / 'friendly' / 'business'
  politeSuppress: false, // true: ä¸å¯§ã™ãæŠ‘åˆ¶ON
  indicatorMode: 'text', // 'off' / 'text' / 'dot' / 'bar'
  responseDetail: 'standard', // 'simple' / 'standard' / 'detailed' (ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨)
  customNames: {}, // AIåã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆä¾‹: { 'yui': 'ã‚«ã‚¹ã‚¿ãƒ å' }ï¼‰
  indicators: {
    thinking: true,
    timeout: true,
    cut: true,
    late: true,
    error: true
  }
};

// â˜…è¿½åŠ ï¼šè¨­å®šã‚’localStorageã‹ã‚‰å¾©å…ƒâ˜…
function loadSettings() {
  try {
    const saved = localStorage.getItem(SETTINGS_STORAGE_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      settings = { ...settings, ...parsed };
    }
  } catch (e) {
    console.warn('Settings load failed:', e);
  }
}

// â˜…è¿½åŠ ï¼šè¨­å®šã‚’localStorageã«ä¿å­˜â˜…
function saveSettings() {
  try {
    localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
  } catch (e) {
    console.warn('Settings save failed:', e);
  }
}

// â˜…è¿½åŠ ï¼šCUTæ¤œçŸ¥é–¢æ•°ï¼ˆæ–‡æœ«ãŒæœªå®Œã§çµ‚äº†ã—ã¦ã„ã‚‹ã‹ã‚’æ¤œçŸ¥ï¼‰â˜…
function _detectCut_(text) {
  if (!text || typeof text !== 'string') return false;
  
  // Markdownè¨˜å·ã‚„HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ã€ç´”ç²‹ãªãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
  let cleanText = text.replace(/<[^>]+>/g, '').replace(/[#*`_~\[\](){}]/g, '').trim();
  if (!cleanText) return false;
  
  // â˜…v17.0.0è¿½åŠ ï¼šã€Œä»¥ä¸Šã€ã§çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã¯å®Œäº†ã¨åˆ¤å®šâ˜…
  if (/ä»¥ä¸Š[ã€‚ï¼ï¼Ÿ\.]?$/.test(cleanText)) {
    return false; // ã€Œä»¥ä¸Šã€ã§çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã¯å®Œäº†
  }
  
  // æ”¹è¡Œã§åˆ†å‰²ã—ã¦ã€æœ€å¾Œã®è¡Œã‚’å–å¾—
  const lines = cleanText.split(/\n/).filter(l => l.trim().length > 0);
  if (lines.length === 0) return false;
  
  const lastLine = lines[lines.length - 1].trim();
  if (!lastLine || lastLine.length < 3) return false; // æœ€å¾Œã®è¡ŒãŒçŸ­ã™ãã‚‹å ´åˆã¯åˆ¤å®šã—ãªã„
  
  // æœ€å¾Œã®æ–‡å­—ãŒå¥ç‚¹ï¼ˆã€‚ï¼ï¼Ÿï¼‰ã§çµ‚ã‚ã£ã¦ã„ã‚‹ã‹ç¢ºèª
  const endsWithPunctuation = /[ã€‚ï¼ï¼Ÿ\.]$/.test(lastLine);
  if (endsWithPunctuation) return false; // å¥ç‚¹ã§çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã¯å®Œäº†
  
  // æœªå®Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œçŸ¥ï¼ˆåŠ©è©ãƒ»åŠ©å‹•è©ã§çµ‚ã‚ã‚‹å ´åˆï¼‰
  // æ—¥æœ¬èªã®åŠ©è©ãƒ»åŠ©å‹•è©ãƒ‘ã‚¿ãƒ¼ãƒ³
  // â˜…ä¿®æ­£ï¼šè§’æ‹¬å¼§ã‚’å…¨æ’¤å»ã—ã¦èªå°¾ã®æ–‡å­—åˆ—ä¸€è‡´ã«ä¿®æ­£ï¼ˆèª¤æ¤œçŸ¥é˜²æ­¢ï¼‰â˜…
  // â˜…ä¿®æ­£ï¼šæ™®é€šã«å®Œçµã—ã¦ã„ã‚‹æ–‡ï¼ˆã€Œã€œã™ã‚‹ã€ã€Œã€œã§ãã‚‹ã€ã€Œã€œã¾ã™ã€ã€Œã€œã§ã™ã€ç­‰ï¼‰ã¯CUTåˆ¤å®šã‹ã‚‰é™¤å¤–â˜…
  const incompletePatterns = [
    // åŠ©è©æ­¢ã¾ã‚Šï¼ˆCUTåˆ¤å®šã‚’ç¶­æŒï¼‰
    /ã®$/, /ãŒ$/, /ã‚’$/, /ã«$/, /ã§$/, /ã¨$/, /ã¯$/, /ã‚‚$/, /ã‹$/, /ã‚„$/, /ã¸$/,
    /ã¦$/, /ã—$/, /ãš$/, /ã‚Œ$/, /ã°$/, /ã‚ˆ$/, /ã­$/, /ãª$/, /ã $/, /ã‚$/,
    // åŠ©å‹•è©ãƒ»èªå°¾ï¼ˆä¸€éƒ¨ã®ã¿CUTåˆ¤å®šï¼‰
    /ã§ã‚ã‚‹$/, /ãªã„$/, /ãŸã„$/, /ã‚ˆã†$/, /ãã†$/, /ã‚‰ã—ã„$/
    // é™¤å¤–: /ã§ã™$/, /ã¾ã™$/, /ã™ã‚‹$/, /ã‚Œã‚‹$/, /ã‚‰ã‚Œã‚‹$/, /ã§ãã‚‹$/ ï¼ˆæ™®é€šã«å®Œçµã—ã¦ã„ã‚‹æ–‡ï¼‰
  ];
  
  // æœ€å¾Œã®è¡ŒãŒæœªå®Œãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
  for (const pattern of incompletePatterns) {
    if (pattern.test(lastLine)) {
      return true; // CUTæ¤œçŸ¥
    }
  }
  
  // æœ€å¾Œã®è¡ŒãŒã€Œ...ã€ã€Œâ€¦ã€ã€Œï¼ï¼ï¼ã€ã§çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã‚‚CUTã¨åˆ¤å®š
  if (/[\.ï¼â€¦]{2,}$/.test(lastLine)) {
    return true; // CUTæ¤œçŸ¥
  }
  
  // æœ€å¾Œã®è¡ŒãŒã€Œã€œã®ã€ã€Œã€œãŒã€ç­‰ã®åŠ©è©ã§çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆï¼ˆã‚ˆã‚Šå³å¯†ãªåˆ¤å®šï¼‰
  if (/[ã®ãŒã‚’ã«ã§ã¨ã¯ã‚‚ã‹ã‚„ã¸]$/.test(lastLine) && lastLine.length < 30) {
    // çŸ­ã„è¡Œã§åŠ©è©ã§çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã¯CUTã®å¯èƒ½æ€§ãŒé«˜ã„
    return true;
  }
  
  return false; // å®Œäº†
}

// â˜…è¿½åŠ ï¼šCUTè‡ªå‹•ç¶™ç¶šã‚’æœ€å¤§2å›ã«å¼·åŒ–ã™ã‚‹é–¢æ•°â˜…
function _handleCutContinuation_(speaker, responseText, context, imgs, sessionId, title, role, id, indicatorId, attemptCount, resolve) {
  const MAX_CUT_ATTEMPTS = 2; // æœ€å¤§2å›
  
  if (attemptCount >= MAX_CUT_ATTEMPTS) {
    // â˜…v16.3.8-hf1ä¿®æ­£ï¼š2å›ã§ã‚‚CUTã®ã¾ã¾çµ‚äº†ã€çµ‚ç«¯è¡¨ç¤ºã‚’ä»˜ä¸â˜…
    const cutEndMsg = `\n\n<span style="color:#f59e0b; font-weight:bold;">ï¼ˆé€”ä¸­ã§åˆ‡ã‚Œã¾ã—ãŸï¼‰</span>`;
    document.getElementById(`ans-${id}`).innerHTML = formatMarkdown(responseText + cutEndMsg);
    // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆCUTçµ‚äº† - æ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰â˜…
    updateIndicator(indicatorId, 'error', settings.indicators.cut ? 'âœ‚ CUT â†’ End' : '');
    // â˜…ä¿®æ­£ï¼šcontextã¯å‘¼ã³å‡ºã—å…ƒã§è¿½åŠ ã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯è¿½åŠ ã—ãªã„ï¼ˆäºŒé‡è¿½åŠ é˜²æ­¢ï¼‰â˜…
    // context += `[${speaker}]: ${responseText}\n`; // å‰Šé™¤ï¼ˆäºŒé‡è¿½åŠ é˜²æ­¢ï¼‰
    resolve(); // å¿…ãšæ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€
    return;
  }
  
  // CUTæ¤œçŸ¥è¡¨ç¤ºã‚’è¿½åŠ ï¼ˆç¶šãè¦æ±‚ä¸­ï¼‰
  const attemptNum = attemptCount + 1;
  const cutIndicator = `\n\n<span style="color:#f59e0b; font-weight:bold;">âœ‚ï¸ CUTæ¤œçŸ¥: ä¼šè©±ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ç¶šãã‚’è¦æ±‚ã—ã¾ã™... (#${attemptNum})</span>`;
  document.getElementById(`ans-${id}`).innerHTML = formatMarkdown(responseText + cutIndicator);
  // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆCUTç¶™ç¶š - æ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰â˜…
  updateIndicator(indicatorId, 'sending', settings.indicators.cut ? `âœ‚ CUT â†’ Continue #${attemptNum}` : '');
  // â˜…ä¿®æ­£ï¼šcontextã¯æ—¢ã«å‘¼ã³å‡ºã—å…ƒã§è¿½åŠ æ¸ˆã¿ãªã®ã§ã€ã“ã“ã§ã¯è¿½åŠ ã—ãªã„ï¼ˆäºŒé‡è¿½åŠ é˜²æ­¢ï¼‰â˜…
  // context += `[${speaker}]: ${responseText}\n`; // å‰Šé™¤ï¼ˆäºŒé‡è¿½åŠ é˜²æ­¢ï¼‰
  
  // ç¶šãè¦æ±‚ã‚’è‡ªå‹•é€ä¿¡
  google.script.run.withSuccessHandler((contRaw) => {
    let contNormalized = null;
    if (typeof contRaw === "string") {
      try { contNormalized = JSON.parse(contRaw); } catch (e) { contNormalized = { status: "success", response: contRaw }; }
    } else if (typeof contRaw === "object" && contRaw !== null) {
      contNormalized = contRaw;
    } else {
      contNormalized = { status: "success", response: String(contRaw || "(ç„¡å¿œç­”)") };
    }
    const contText = contNormalized.response || contNormalized.text || contNormalized.message || String(contNormalized || "(ç„¡å¿œç­”)");
    const combinedText = responseText + '\n\n**ï¼ˆç¶šã #' + attemptNum + 'ï¼‰**\n' + contText;
    
    // ç¶šãã‚‚CUTã‹ãƒã‚§ãƒƒã‚¯
    const isStillCut = _detectCut_(contText);
    if (isStillCut && attemptCount < MAX_CUT_ATTEMPTS - 1) {
      // ã¾ã CUTã§ã€æ®‹ã‚Šè©¦è¡Œå›æ•°ãŒã‚ã‚‹å ´åˆã¯å†å¸°çš„ã«ç¶šãè¦æ±‚
      _handleCutContinuation_(speaker, combinedText, context, imgs, sessionId, title, role, id, indicatorId, attemptCount + 1, resolve);
    } else {
      // â˜…v16.3.8-hf1ä¿®æ­£ï¼šç¶šããŒå®Œæˆã—ãŸå ´åˆã€çµ‚ç«¯è¡¨ç¤ºã‚’ä»˜ä¸â˜…
      const finalText = isStillCut 
        ? combinedText + '\n\n<span style="color:#f59e0b; font-weight:bold;">ï¼ˆé€”ä¸­ã§åˆ‡ã‚Œã¾ã—ãŸï¼‰</span>'
        : combinedText + '\n\n<span style="color:#10b981; font-weight:bold;">ï¼ˆçµ‚äº†ï¼‰</span>';
      document.getElementById(`ans-${id}`).innerHTML = formatMarkdown(finalText);
      // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆCUTå®Œäº†/ç¶™ç¶šçµ‚äº† - æ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰â˜…
      if (isStillCut && settings.indicators.cut) {
        updateIndicator(indicatorId, 'error', settings.indicatorMode === 'text' ? 'âœ‚ CUT â†’ End' : '');
      } else {
        updateIndicator(indicatorId, 'completed', settings.indicatorMode === 'text' ? 'âœ“ Received' : '');
      }
      // â˜…ä¿®æ­£ï¼šcontextã¯æ—¢ã«å‘¼ã³å‡ºã—å…ƒã§è¿½åŠ æ¸ˆã¿ãªã®ã§ã€ç¶šãéƒ¨åˆ†ã®ã¿è¿½åŠ â˜…
      context += `[${speaker}]: ${contText}\n`;
      resolve(); // ç¶šãè¦æ±‚å®Œäº†å¾Œã«æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€
    }
  }).withFailureHandler(() => {
    // ç¶šãè¦æ±‚å¤±æ•—æ™‚ã¯ã€å…ƒã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ç¶šè¡Œï¼ˆCUTæ¤œçŸ¥è¡¨ç¤ºã®ã¿ï¼‰
    const fullText = responseText + '\n\n<span style="color:#f59e0b; font-weight:bold;">âœ‚ï¸ CUTæ¤œçŸ¥: ä¼šè©±ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã¾ã™ï¼ˆç¶šãè¦æ±‚å¤±æ•—ï¼‰</span>';
    document.getElementById(`ans-${id}`).innerHTML = formatMarkdown(fullText);
    // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆCUTå¤±æ•— - æ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰â˜…
    updateIndicator(indicatorId, 'error', settings.indicators.cut ? 'âœ‚ CUT â†’ Failed' : '');
    context += `[${speaker}]: ${responseText}\n`;
    resolve(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€
  }).runConferenceTurn(speaker, context, "å‰ã®å›ç­”ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ç¶šãã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚", imgs, sessionId, title, role);
}

// â˜…v17.0.0ä¿®æ­£ï¼šè¡¨ç¤ºåã®æ­£è¦åŒ–é–¢æ•°ï¼ˆå›ºå®šåã®ã¿ã€Alpha/Betaç­‰ã‚’å»ƒæ­¢ã€ã‚«ã‚¹ã‚¿ãƒ åå„ªå…ˆï¼‰â˜…
function normalizeDisplayName(speaker, role) {
  // â˜…v17.0.0è¿½åŠ ï¼šã‚«ã‚¹ã‚¿ãƒ åã‚’å„ªå…ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸåå‰ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ï¼‰â˜…
  const lowerSpeaker = String(speaker || '').toLowerCase().trim();
  if (settings.customNames && settings.customNames[lowerSpeaker] && settings.customNames[lowerSpeaker].trim()) {
    return settings.customNames[lowerSpeaker].trim();
  }
  
  // å›ºå®šã®AIåãƒãƒƒãƒ—ï¼ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åãƒ™ãƒ¼ã‚¹ã§å›ºå®šã€å‹æ‰‹ãªå¤‰åç¦æ­¢ï¼‰
  const fixedNameMap = {
    // æ—¢å­˜ã®AIåï¼ˆå°æ–‡å­—ã§çµ±ä¸€ï¼‰
    'yui': 'Yui',
    'gemini': 'Gemini',
    'rex': 'Rex',
    'deepseek': 'DeepSeek',
    'llama': 'Llama',
    'qwen': 'Qwen',
    'mistral': 'Mistral',
    'dolphin': 'Dolphin',
    // å½¹å‰²åâ†’ãƒ¢ãƒ‡ãƒ«åï¼ˆå›ºå®šï¼‰
    'imageanalyzer': 'Gemini',
    'factchecker': 'Gemini',
    'codereviewer': 'Rex',
    'techadvisor': 'Rex',
    'proposer': 'Gemini',
    'opposer': 'Gemini',
    'observer': 'Gemini',
    // Alpha/Betaç­‰ã®ç¦æ­¢åã¯å…¨ã¦UNKNOWNæ‰±ã„
    'alpha': 'UNKNOWN',
    'beta': 'UNKNOWN',
    'gamma': 'UNKNOWN',
    'delta': 'UNKNOWN'
  };
  
  // å›ºå®šãƒãƒƒãƒ—ã«å­˜åœ¨ã™ã‚‹å ´åˆ
  if (fixedNameMap[lowerSpeaker]) {
    return fixedNameMap[lowerSpeaker];
  }
  
  // å½¹å‰²åã®å ´åˆï¼ˆroleã‹ã‚‰æ¤œç´¢ï¼‰
  if (role) {
    const roleKey = String(role).replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
    if (fixedNameMap[roleKey]) {
      return fixedNameMap[roleKey];
    }
  }
  
  // â˜…v17.0.0ä¿®æ­£ï¼šæœªå®šç¾©ãƒ»Alpha/Betaç­‰ã¯å…¨ã¦UNKNOWNæ‰±ã„ï¼ˆå‹æ‰‹ãªåå‰ã‚’ç”Ÿæˆã—ãªã„ï¼‰â˜…
  return 'UNKNOWN';
}

// â˜…v17.0.0ä¿®æ­£ï¼šMarkdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ï¼ˆã™ã¹ã¦ã®AIå›ç­”ã®æœ€å¾Œã«ã€Œä»¥ä¸Šã€‚ã€ã‚’ä»˜ã‘ã‚‹ï¼‰â˜…
function formatMarkdown(text) {
  if (!text) return '';
  
  // ç°¡æ˜“Markdownå‡¦ç†
  let formatted = text;
  
  // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å‡¦ç†
  formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (m, l, c) => {
    const i = codeSnippets.length;
    codeSnippets.push({ l: l||'text', c: c.trim() });
    return `__CODE_${i}__`;
  });
  
  // â˜…v17.0.0è¿½åŠ ï¼šã™ã¹ã¦ã®AIå›ç­”ã®æœ€å¾Œã«ã€Œä»¥ä¸Šã€‚ã€ã‚’ä»˜ã‘ã‚‹ï¼ˆæ—¢ã«ã€Œä»¥ä¸Šã€ã§çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã¯é‡è¤‡ã—ãªã„ï¼‰â˜…
  const cleanText = formatted.replace(/<[^>]+>/g, '').trim(); // HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦åˆ¤å®š
  if (cleanText && !/ä»¥ä¸Š[ã€‚ï¼ï¼Ÿ\.]?$/.test(cleanText)) {
    formatted = formatted + '<br><br><span style="color:#64748b; font-weight:bold;">ä»¥ä¸Šã€‚</span>';
  }
  
  // æ”¹è¡Œå‡¦ç†
  formatted = formatted.replace(/\n/g, '<br>');
  
  // å¤ªå­—å‡¦ç†
  formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  
  // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒœã‚¿ãƒ³ã«å¤‰æ›
  formatted = formatted.replace(/__CODE_(\d+)__/g, (m, i) => {
    if (codeSnippets[i]) {
      return `<button class="code-link-btn" onclick="openCode(${i})">ğŸ“œ ã‚³ãƒ¼ãƒ‰ (${codeSnippets[i].l})</button>`;
    }
    return '';
  });
  
  return formatted;
}

// â˜…è¿½åŠ ï¼šopenModalé–¢æ•°ï¼ˆæ¬ å“ã‚¼ãƒ­å¯¾ç­–ï¼‰â˜…
function openModal(id) {
  const el = document.getElementById(id);
  if (el) {
    el.style.display = 'flex';
  }
}

// â˜…è¿½åŠ ï¼šcloseModalé–¢æ•°ï¼ˆæ¬ å“ã‚¼ãƒ­å¯¾ç­–ï¼‰â˜…
function closeModal(id) {
  const el = document.getElementById(id);
  if (el) {
    el.style.display = 'none';
  }
}

// â˜…v17.0.0è¿½åŠ ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°é–¢æ•°ï¼ˆæ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰â˜…
function updateIndicator(indicatorId, state, text) {
  const indicatorEl = document.getElementById(indicatorId);
  if (!indicatorEl) return;
  
  const indicatorMode = settings.indicatorMode || 'text';
  
  if (indicatorMode === 'off') {
    indicatorEl.style.display = 'none';
    indicatorEl.style.opacity = '0';
    return;
  }
  
  if (indicatorMode === 'dot') {
    // ãƒ‰ãƒƒãƒˆæ–¹å¼ï¼šçŠ¶æ…‹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
    indicatorEl.className = `indicator-dot ${state}`;
    indicatorEl.style.display = 'inline-block';
    indicatorEl.style.opacity = '1';
  } else if (indicatorMode === 'bar') {
    // ãƒãƒ¼æ–¹å¼ï¼šçŠ¶æ…‹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
    indicatorEl.className = `indicator-bar ${state}`;
    indicatorEl.style.display = 'block';
    indicatorEl.style.opacity = '1';
    // ãƒãƒ¼æ–¹å¼ã®å ´åˆã€é€²æ—ã‚’æ›´æ–°
    const progressEl = indicatorEl.querySelector('.indicator-bar-progress');
    if (progressEl) {
      if (state === 'waiting') {
        progressEl.style.width = '0%';
      } else if (state === 'sending') {
        progressEl.style.width = '30%';
      } else if (state === 'receiving') {
        progressEl.style.width = '70%';
      } else if (state === 'completed') {
        progressEl.style.width = '100%';
      } else if (state === 'error') {
        progressEl.style.width = '100%';
      }
    }
  } else {
    // å¾“æ¥æ–¹å¼ï¼ˆtextï¼‰
    indicatorEl.textContent = text || '';
    indicatorEl.style.opacity = text ? '1' : '0';
    indicatorEl.style.display = '';
  }
}

window.onload = () => { 
  updateClock(); 
  setInterval(updateClock,60000); 
  loadSettings(); // â˜…è¿½åŠ ï¼šè¨­å®šã‚’å¾©å…ƒâ˜…
  initUI(); 
  applySettingsToUI(); // â˜…è¿½åŠ ï¼šè¨­å®šã‚’UIã«åæ˜ â˜…
  // â˜…v17.0.6-btndead1: onclickäº’æ›ãƒ¬ã‚¤ãƒ¤ï¼ˆevalç¦æ­¢ãƒ»æ­£è¦è¡¨ç¾è§£ææ–¹å¼ï¼‰â˜…
  __bindOnclickCompat__();
  // â˜…v17.0.7-upload-btndead: debug=1æ™‚ã®ã¿ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚­ãƒ£ãƒ—ãƒãƒ£ã§åŸå› åˆ‡ã‚Šåˆ†ã‘â˜…
  __initClickObserver__();
};

function initUI() {
  const con = document.getElementById('agentBadges');
  const mcSel = document.getElementById('mcSelect');
  mcSel.innerHTML = ""; con.innerHTML = "";
  
  AGENTS.forEach(a => {
    const span = document.createElement('span');
    span.className = `agent-badge ${selected.includes(a)?'selected':''}`;
    span.setAttribute('data-agent', a); span.id = `badge-${a}`;
    span.innerText = a.charAt(0).toUpperCase() + a.slice(1);
    span.onclick = () => toggleAgent(a);
    con.appendChild(span);
    const opt = document.createElement('option');
    opt.value = a; opt.innerText = a.charAt(0).toUpperCase() + a.slice(1);
    mcSel.appendChild(opt);
  });
  
  // â˜…è¿½åŠ ï¼šå¸ä¼šAIé¸æŠæ™‚ã®changeã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—¢ã«é¸ã°ã‚Œã¦ã„ã‚‹å¸ä¼šAIã‚’è‡ªå‹•ã§å¤–ã™ï¼‰â˜…
  mcSel.addEventListener('change', function() {
    const newMc = this.value;
    // æ—¢ã«é¸ã°ã‚Œã¦ã„ã‚‹å¸ä¼šAIã‚’selectedã‹ã‚‰é™¤å¤–
    selected = selected.filter(a => a !== newMc);
    // ãƒãƒƒã‚¸çŠ¶æ…‹ã‚’å†æç”»
    _updateBadgeStates_();
  });
  
  // åˆæœŸçŠ¶æ…‹ã§ãƒãƒƒã‚¸çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆå¸ä¼šAIã‚’é™¤å¤–ï¼‰
  _updateBadgeStates_();
}

function updateClock(){document.getElementById('clock').innerText=new Date().toLocaleString('ja-JP',{hour:'2-digit',minute:'2-digit'});}
function setFontSize(s) {
  const r = document.body; document.querySelectorAll('.font-btn').forEach(b=>b.classList.remove('active'));
  if(s==='small'){r.style.fontSize='14px'; document.querySelectorAll('.font-btn')[0].classList.add('active');}
  if(s==='medium'){r.style.fontSize='16px'; document.querySelectorAll('.font-btn')[1].classList.add('active');}
  if(s==='large'){r.style.fontSize='20px'; document.querySelectorAll('.font-btn')[2].classList.add('active');}
}

function setMode(mode) {
  currentMode = mode;
  document.getElementById('mode-auto').classList.toggle('active', mode==='auto');
  document.getElementById('mode-manual').classList.toggle('active', mode==='manual');
  document.getElementById('settingsArea').style.display = 'block';
  document.getElementById('mcWrapper').style.display = (mode==='auto') ? 'block' : 'none';
  document.getElementById('roundWrapper').style.display = (mode==='auto') ? 'block' : 'none';
  document.getElementById('mainStage').style.display = 'none';
  document.getElementById('manualGrid').style.display = 'none';
  document.getElementById('progressZone').style.display = 'none';
  // â˜…v17.0.0è¿½åŠ ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰æ™‚ã«é€ä¿¡å…ˆé¸æŠUIã‚’è¡¨ç¤ºâ˜…
  document.getElementById('manualSendArea').style.display = (mode==='manual') ? 'block' : 'none';
  if (mode === 'manual') {
    initManualSendTargets();
  }
}

// â˜…ä¿®æ­£ï¼šå¸ä¼šAIã¯å‚åŠ è€…ã¨ã—ã¦é¸ã¹ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆæ’ä»–åˆ¶å¾¡ï¼‰â˜…
function toggleAgent(a) {
  // â˜…ä¿®æ­£ï¼šå¸ä¼šAIï¼ˆmcï¼‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯â˜…
  const currentMc = document.getElementById('mcSelect')?.value;
  if (a === currentMc) {
    return; // å¸ä¼šAIã¯å‚åŠ è€…ã¨ã—ã¦é¸ã¹ãªã„
  }
  
  if(selected.includes(a)) { if(selected.length > 1) selected = selected.filter(x => x!==a); }
  else selected.push(a);
  
  // â˜…ä¿®æ­£ï¼šãƒãƒƒã‚¸çŠ¶æ…‹ã‚’å†æç”»ï¼ˆå¸ä¼šAIã‚’é™¤å¤–ï¼‰â˜…
  _updateBadgeStates_();
}

// â˜…è¿½åŠ ï¼šãƒãƒƒã‚¸çŠ¶æ…‹ã‚’å†æç”»ã™ã‚‹é–¢æ•°ï¼ˆå¸ä¼šAIã‚’é™¤å¤–ï¼‰â˜…
function _updateBadgeStates_() {
  const currentMc = document.getElementById('mcSelect')?.value;
  AGENTS.forEach(ag => {
    const el = document.getElementById(`badge-${ag}`);
    if (!el) return;
    
    // å¸ä¼šAIã¯å‚åŠ è€…ã¨ã—ã¦é¸ã¹ãªã„ã®ã§ã€selectedã‹ã‚‰é™¤å¤–
    if (ag === currentMc) {
      selected = selected.filter(x => x !== ag);
      el.classList.remove('selected');
      // â˜…ä¿®æ­£ï¼šè¦‹ãŸç›®å¤‰æ›´ãªã—ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã§å¼¾ãã®ã¿ï¼‰â˜…
    } else {
      if(selected.includes(ag)) el.classList.add('selected'); 
      else el.classList.remove('selected');
    }
  });
}

function insertTemplate() {
  const t = document.getElementById('themeInput');
  const template = `\n--------------------------------------------------\nã€ãƒ•ã‚¡ã‚¤ãƒ«å: index.htmlã€‘\n(ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚‹)\n\n--------------------------------------------------\nã€ãƒ•ã‚¡ã‚¤ãƒ«å: Code.gsã€‘\n(ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚‹)\n`;
  t.value = t.value + template; t.focus();
}

function resetInput() { document.getElementById('themeInput').value = ''; imagesBase64 = []; document.getElementById('previewArea').innerHTML = ''; }
function tryReset() { openModal('resetModal'); }
function performReset() { localStorage.removeItem(STORAGE_KEY); location.reload(); }

function buildProgressBar(totalSteps) {
  const bar = document.getElementById('progressBarInner');
  bar.innerHTML = '<div class="progress-line"></div>';
  for(let i=1; i<=totalSteps; i++) {
    let label = i===1 ? "é–‹å§‹" : i===totalSteps ? "å®Œäº†" : "è­°è«–";
    bar.innerHTML += `<div class="step" id="s${i}"><div class="step-dot">${i}</div><div class="step-label">${label}</div></div>`;
  }
}
function updateStep(s){ 
  const steps = document.querySelectorAll('.step');
  steps.forEach((el, idx) => { if(idx+1 === s) el.classList.add('active'); else el.classList.remove('active'); });
}

function startProcess() {
  const theme = document.getElementById('themeInput').value;
  if(!theme) return alert("è­°é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!currentMode) return alert("ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„");
  document.getElementById('statusText').innerText = "ğŸš€ å®Ÿè¡Œä¸­...";
  if(currentMode === 'auto') startAuto(theme); else startManual(theme);
}

// â˜…ä¿®æ­£ï¼šã‚ªãƒ¼ãƒˆä¼šè©±ãƒ«ãƒ¼ãƒ—ã‚’async/awaitã«å¤‰æ›´ï¼ˆå¿…ãšæ¬¡ã¸é€²ã‚€æ§‹é€ ï¼‰â˜…
async function startAuto(theme) {
  document.getElementById('mainStage').style.display = 'block';
  document.getElementById('progressZone').style.display = 'block';
  document.getElementById('timeline').innerHTML = '';
  
  const mc = document.getElementById('mcSelect').value;
  const rounds = parseInt(document.getElementById('roundSelect').value, 10);
  
  // â˜…ä¿®æ­£â‘ ï¼šselectedãŒç©ºã®å ´åˆã€å…¨å“¡ã‚’é¸æŠï¼ˆAGENTSå…¨éƒ¨ï¼‰â˜…
  let targets = selected.length > 0 ? selected.filter(a => a !== mc) : AGENTS.filter(a => a !== mc);
  
  // â˜…ä¿®æ­£â‘ ï¼štargetsãŒç©ºã¾ãŸã¯1äººä»¥ä¸‹ã®å ´åˆã€è­¦å‘Šã‚’è¡¨ç¤ºâ˜…
  if (targets.length < 2) {
    alert('ã‚ªãƒ¼ãƒˆä¼šè­°ã¯2äººä»¥ä¸Šã®AIãŒå¿…è¦ã§ã™ã€‚');
    document.getElementById('statusText').innerText = "âŒ ã‚¨ãƒ©ãƒ¼: AIãŒä¸è¶³";
    return;
  }
  
  try {
    // å½¹å‰²å‰²ã‚Šå½“ã¦
    // â˜…ä¿®æ­£ï¼šå¸ä¼šAIï¼ˆmcï¼‰ã‚’é™¤å¤–ã—ã¦å½¹å‰²å‰²ã‚Šå½“ã¦ï¼ˆæ’ä»–åˆ¶å¾¡ï¼‰â˜…
    const participants = (selected.length > 0 ? selected : AGENTS).filter(a => a !== mc);
    const roles = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getRoleAssignment(participants, mc);
    });
    
    assignedRoles = roles;
    context = `[User]: ${theme}\n`;
    const title = document.getElementById('topicTitle').value;
    const imgs = [...imagesBase64];
    let stepCount = 1;

    // å¸ä¼šã®ç™ºè¨€
    const mcInstr = _applySettingsToInstruction_(`ãƒ¦ãƒ¼ã‚¶ãƒ¼è­°é¡Œ:ã€Œ${theme}ã€\nå¸ä¼šã¨ã—ã¦è­°è«–ã‚’é–‹å§‹ã—ã€å½¹å‰²ï¼ˆææ¡ˆè€…ãƒ»åè«–è€…ï¼‰ã‚’æŒ‡åã—ã¦è­°è«–ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚`);
    await runStep(mc, mcInstr, imgs, title, stepCount++, 'mc');

    // ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®ç™ºè¨€
    for (let r = 1; r <= rounds; r++) {
      let prefix = (rounds > 1) ? `ã€ãƒ©ã‚¦ãƒ³ãƒ‰ ${r}/${rounds}ã€‘` : "";
      const proposers = targets.filter(a => assignedRoles[a] === 'proposer');
      for (const agent of proposers) {
        const proposerInstr = _applySettingsToInstruction_(`${prefix}ææ¡ˆè€…ã¨ã—ã¦ã€å…·ä½“çš„ã‹ã¤è«–ç†çš„ãªè§£æ±ºç­–ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚`);
        await runStep(agent, proposerInstr, imgs, title, stepCount++, 'proposer');
      }
      const others = targets.filter(a => assignedRoles[a] !== 'proposer');
      for (const agent of others) {
        let role = assignedRoles[agent];
        let msg = `${prefix}ææ¡ˆã«å¯¾ã—ã¦æ„è¦‹ã—ã¦ãã ã•ã„ã€‚`;
        if(role === 'opposer') msg = `${prefix}åè«–è€…ã¨ã—ã¦ã€ææ¡ˆã®ãƒªã‚¹ã‚¯ã‚„æ¬ é™¥ã‚’å³ã—ãæŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚`;
        if(role === 'tech') msg = `${prefix}æŠ€è¡“é¡§å•ã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚„å®Ÿè£…ã®å®Ÿç¾å¯èƒ½æ€§ã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„ã€‚`;
        const agentInstr = _applySettingsToInstruction_(msg);
        await runStep(agent, agentInstr, imgs, title, stepCount++, role);
      }
    }

    // æœ€çµ‚ç™ºè¨€
    const finalInstBase = `è­°è«–ã‚’ç·æ‹¬ã—ã€ææ¡ˆãƒ»åè«–ãƒ»æŠ€è¡“æ¤œè¨¼ã‚’çµ±åˆã—ã¦ã€æœ€çµ‚çš„ãªã€å®Œå…¨ãªè§£æ±ºç­–/ã‚³ãƒ¼ãƒ‰ã€‘ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
    const finalInst = _applySettingsToInstruction_(finalInstBase);
    await runStep(mc, finalInst, imgs, title, stepCount, 'mc');
    
    document.getElementById('statusText').innerText = "âœ… å®Œäº†";
    saveStorage();
  } catch (e) {
    document.getElementById('statusText').innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + (e.message || e);
    document.getElementById('statusText').style.color = 'red';
    console.error("startAuto error:", e);
  }
}

// â˜…ä¿®æ­£ï¼šrunStepé–¢æ•°ã‚’async/awaitã«å¤‰æ›´ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã®é…å»¶ãƒ­ã‚°å›åã‚’ç¢ºå®Ÿã«å·®ã—è¾¼ã‚€â˜…
function runStep(speaker, instr, imgs, title, step, role){
  return new Promise((resolve, reject)=>{
    updateStep(step);
    const tl = document.getElementById('timeline');
    const id = Date.now();
    let roleBadge = ""; let roleClass = "";
    if(role === 'proposer') { roleBadge='<span class="role-badge" style="background:var(--role-proposer);">ææ¡ˆ</span>'; roleClass='role-proposer'; }
    if(role === 'opposer') { roleBadge='<span class="role-badge" style="background:var(--role-opposer);">åè«–</span>'; roleClass='role-opposer'; }
    if(role === 'tech') { roleBadge='<span class="role-badge" style="background:var(--role-tech);">æŠ€è¡“</span>'; roleClass='role-tech'; }

    // â˜…ä¿®æ­£ï¼šè¡¨ç¤ºåã®æ­£è¦åŒ–â˜…
    const displayName = normalizeDisplayName(speaker, role);
    // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿è¡¨ç¤ºç”¨ã®IDï¼ˆæ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰â˜…
    const indicatorId = `indicator-${id}`;
    const indicatorMode = settings.indicatorMode || 'text';
    let indicatorHTML = '';
    
    if (indicatorMode === 'off') {
      indicatorHTML = '';
    } else if (indicatorMode === 'dot') {
      indicatorHTML = `<span class="indicator-dot sending" id="${indicatorId}"></span>`;
    } else if (indicatorMode === 'bar') {
      indicatorHTML = `<div class="indicator-bar sending" id="${indicatorId}"><div class="indicator-bar-progress"></div></div>`;
    } else {
      // å¾“æ¥æ–¹å¼ï¼ˆtextï¼‰
      const indicatorText = settings.indicators.thinking ? 'Thinking...' : '';
      const indicatorStyle = settings.indicators.thinking ? '' : 'style="opacity:0;"';
      indicatorHTML = `<span id="${indicatorId}" ${indicatorStyle}>${indicatorText}</span>`;
    }
    
    tl.insertAdjacentHTML('beforeend', `<div class="timeline-card ${roleClass}">${indicatorMode === 'bar' ? indicatorHTML : ''}<div class="tl-header h-${speaker}"><span>${displayName} ${roleBadge}</span>${indicatorMode !== 'bar' ? indicatorHTML : ''}</div><div class="tl-body" id="ans-${id}"><div class="loader">...</div></div></div>`);
    
    // â˜…v17.0.0è¿½åŠ ï¼šåˆæœŸçŠ¶æ…‹ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆé€ä¿¡ä¸­ï¼‰â˜…
    if (indicatorMode === 'dot' || indicatorMode === 'bar') {
      updateIndicator(indicatorId, 'sending', '');
    }
    window.scrollTo(0, document.body.scrollHeight);
    
    // â˜…ä¿®æ­£ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ60ç§’ï¼‰â˜…
    const WATCHDOG_MS = 60000;
    let done = false;
    let retryCount = 0;
    const MAX_RETRY = 10; // æœ€å¤§10å›å†å–å¾—ï¼ˆç´„5åˆ†é–“ï¼‰
    let retryTimer = null;
    
    const timer = setTimeout(() => {
      if (done) return;
      done = true;
      const msg = `(â± ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${WATCHDOG_MS/1000}ç§’ å¿œç­”ãªã— â†’ æ¬¡ã¸é€²ã¿ã¾ã™)`;
      const ansEl = document.getElementById(`ans-${id}`);
      if (ansEl) ansEl.innerHTML = `<span style="color:#b45309; font-weight:bold;">${msg}</span>`;
      // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆTimeout - æ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰â˜…
      updateIndicator(`indicator-${id}`, 'error', settings.indicators.timeout ? 'â± Timeout (move on)' : '');
      
      // â˜…v17.0.0è¿½åŠ ï¼šãƒ‰ãƒƒãƒˆ/ãƒãƒ¼æ–¹å¼ã§ã‚‚ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’è¡¨ç¤ºâ˜…
      if (settings.indicatorMode === 'dot' || settings.indicatorMode === 'bar') {
        updateIndicator(`indicator-${id}`, 'error', '');
      }
      context += `[${speaker}]: ${msg}\n`;
      resolve(); // ä¼šè­°ã¯å…ˆã¸é€²ã‚€ï¼ˆdone=trueã§resolveï¼‰
      
      // â˜…ä¿®æ­£ï¼šé…å»¶ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å®šæœŸçš„ã«å†å–å¾—ã—ã¦å·®ã—è¾¼ã‚€â˜…
      retryTimer = setInterval(() => {
        if (retryCount >= MAX_RETRY) {
          if (retryTimer) clearInterval(retryTimer);
          return;
        }
        retryCount++;
        
        // ãƒ­ã‚°ã‚’å†å–å¾—
        google.script.run.withSuccessHandler((logs) => {
          if (!Array.isArray(logs) || logs.length === 0) return;
          
          // æœ€å¾Œã®ç™ºè¨€è€…ã¨speakerãŒä¸€è‡´ã™ã‚‹ãƒ­ã‚°ã‚’æ¢ã™
          const lastLog = logs[logs.length - 1];
          if (lastLog && lastLog.speaker === speaker && lastLog.content) {
            const ansEl = document.getElementById(`ans-${id}`);
            if (ansEl && !ansEl.innerHTML.includes(lastLog.content)) {
              // é…å»¶ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å·®ã—è¾¼ã¿
              ansEl.innerHTML = `<span style="color:#10b981; font-weight:bold;">(é…å»¶ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—)</span><br>` + formatMarkdown(lastLog.content);
              // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆLate - æ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰â˜…
              updateIndicator(`indicator-${id}`, 'completed', settings.indicators.late ? 'â†» Late response fetched' : '');
              
              // â˜…v17.0.0è¿½åŠ ï¼šãƒ‰ãƒƒãƒˆ/ãƒãƒ¼æ–¹å¼ã§ã‚‚å®Œäº†çŠ¶æ…‹ã‚’è¡¨ç¤ºâ˜…
              if (settings.indicatorMode === 'dot' || settings.indicatorMode === 'bar') {
                updateIndicator(`indicator-${id}`, 'completed', '');
              }
              context += `[${speaker}]: ${lastLog.content}\n`;
              if (retryTimer) clearInterval(retryTimer); // å–å¾—ã§ããŸã‚‰çµ‚äº†
            }
          }
        }).withFailureHandler(() => {
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ¬¡ã®å†å–å¾—ã‚’è©¦ã™
        }).getSessionLogs(sessionId);
      }, 30000); // 30ç§’ã”ã¨ã«å†å–å¾—
      
    }, WATCHDOG_MS);

    google.script.run.withSuccessHandler(raw => {
      if (done) {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã«è¿”ã£ã¦ããŸå ´åˆã¯ã€æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„
        const ansEl = document.getElementById(`ans-${id}`);
        if (ansEl && !ansEl.innerHTML.includes("é…å»¶ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—") && !ansEl.innerHTML.includes("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ")) {
          // ã¾ã é…å»¶ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿æ›´æ–°
          ansEl.innerHTML = formatMarkdown(raw.response || raw.text || raw.message || String(raw || "(ç„¡å¿œç­”)"));
          context += `[${speaker}]: ${raw.response || raw.text || raw.message || String(raw || "(ç„¡å¿œç­”)")}\n`;
        }
        if (retryTimer) clearInterval(retryTimer);
        return;
      }
      done = true;
      clearTimeout(timer);
      if (retryTimer) clearInterval(retryTimer);

      // â˜…ä¿®æ­£â‘¡ï¼šè¿”ã‚Šå€¤ã‚’æ­£è¦åŒ–ï¼ˆstring/objectã®æºã‚Œã‚’å¸åï¼‰â˜…
      let normalized = null;
      if (typeof raw === "string") {
        try {
          normalized = JSON.parse(raw);
        } catch (e) {
          normalized = { status: "success", response: raw };
        }
      } else if (typeof raw === "object" && raw !== null) {
        normalized = raw;
      } else {
        normalized = { status: "success", response: String(raw || "(ç„¡å¿œç­”)") };
      }
      
      // responseãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«å–å¾—
      let responseText = normalized.response || normalized.text || normalized.message || String(normalized || "(ç„¡å¿œç­”)");
      
      // â˜…è¿½åŠ ï¼šCUTæ¤œçŸ¥ï¼ˆæ–‡æœ«ãŒæœªå®Œã§çµ‚äº†ã—ã¦ã„ã‚‹ã‹ã‚’æ¤œçŸ¥ï¼‰â˜…
      const isCut = _detectCut_(responseText);
      const autoContinueEnabled = true; // å¸¸ã«ON
      
      // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆReceived - æ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰â˜…
      updateIndicator(`indicator-${id}`, 'completed', 'âœ“ Received');
      
      // â˜…v17.0.0è¿½åŠ ï¼šãƒ‰ãƒƒãƒˆ/ãƒãƒ¼æ–¹å¼ã§ã‚‚å®Œäº†çŠ¶æ…‹ã‚’è¡¨ç¤ºâ˜…
      if (settings.indicatorMode === 'dot' || settings.indicatorMode === 'bar') {
        updateIndicator(`indicator-${id}`, 'completed', '');
      }
      
      if (isCut && autoContinueEnabled) {
        // â˜…ä¿®æ­£ï¼šCUTè‡ªå‹•ç¶™ç¶šã‚’æœ€å¤§2å›ã«å¼·åŒ–â˜…
        _handleCutContinuation_(speaker, responseText, context, imgs, sessionId, title, role, id, indicatorId, 0, resolve);
      } else {
        // â˜…v17.0.0ä¿®æ­£ï¼šCUTæ¤œçŸ¥ãªã—ã®å ´åˆã€formatMarkdownã§ã€Œä»¥ä¸Šã€‚ã€ãŒè‡ªå‹•è¿½åŠ ã•ã‚Œã‚‹â˜…
        document.getElementById(`ans-${id}`).innerHTML = formatMarkdown(responseText);
        context += `[${speaker}]: ${responseText}\n`;
        resolve(); // å¿…ãšæ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€
      }
    }).withFailureHandler(err => {
      if (done) {
        if (retryTimer) clearInterval(retryTimer);
        return;
      }
      done = true;
      clearTimeout(timer);
      if (retryTimer) clearInterval(retryTimer);
      
      // â˜…ä¿®æ­£â‘¢ï¼šã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€ï¼ˆå¿…ãšresolveï¼‰â˜…
      const errorText = `(ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼)\n${err.message || err}`;
      document.getElementById(`ans-${id}`).innerHTML = `<span style="color:red;">${errorText}</span>`;
      // â˜…v17.0.0ä¿®æ­£ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°ï¼ˆError - æ–¹å¼ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰â˜…
      updateIndicator(`indicator-${id}`, 'error', settings.indicators.error ? 'âš  Error' : '');
      
      // â˜…v17.0.0è¿½åŠ ï¼šãƒ‰ãƒƒãƒˆ/ãƒãƒ¼æ–¹å¼ã§ã‚‚ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’è¡¨ç¤ºâ˜…
      if (settings.indicatorMode === 'dot' || settings.indicatorMode === 'bar') {
        updateIndicator(`indicator-${id}`, 'error', '');
      }
      context += `[${speaker}]: ${errorText}\n`;
      resolve(); // å¿…ãšæ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€ï¼ˆrejectã—ãªã„ï¼‰
    }).runConferenceTurn(speaker, context, instr, imgs, sessionId, title, role);
  });
}

// â˜…v17.0.0è¿½åŠ ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€ä¿¡å…ˆé¸æŠUIã‚’åˆæœŸåŒ–â˜…
function initManualSendTargets() {
  const mc = document.getElementById('mcSelect')?.value;
  const targets = AGENTS.filter(a => a !== mc);
  const container = document.getElementById('manualSendTargets');
  container.innerHTML = '';
  
  targets.forEach(agent => {
    const badge = document.createElement('span');
    badge.className = 'manual-send-target-badge';
    badge.setAttribute('data-agent', agent);
    badge.textContent = normalizeDisplayName(agent, null);
    badge.onclick = () => toggleManualTarget(agent);
    if (manualSelectedTargets.includes(agent)) {
      badge.classList.add('selected');
    }
    container.appendChild(badge);
  });
  
  updateManualSendLastTarget();
}

// â˜…v17.0.0è¿½åŠ ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€ä¿¡å…ˆã®ãƒˆã‚°ãƒ«â˜…
function toggleManualTarget(agent) {
  if (manualSelectedTargets.includes(agent)) {
    manualSelectedTargets = manualSelectedTargets.filter(a => a !== agent);
  } else {
    manualSelectedTargets.push(agent);
  }
  initManualSendTargets();
}

// â˜…v17.0.0è¿½åŠ ï¼šå…¨å“¡é¸æŠâ˜…
function selectAllManualTargets() {
  const mc = document.getElementById('mcSelect')?.value;
  manualSelectedTargets = AGENTS.filter(a => a !== mc);
  initManualSendTargets();
}

// â˜…v17.0.0è¿½åŠ ï¼šé¸æŠè§£é™¤â˜…
function clearManualTargets() {
  manualSelectedTargets = [];
  initManualSendTargets();
}

// â˜…v17.0.0è¿½åŠ ï¼šå‰å›é€ä¿¡å…ˆè¡¨ç¤ºæ›´æ–°â˜…
function updateManualSendLastTarget() {
  const el = document.getElementById('manualSendLastTarget');
  if (lastManualTarget && lastManualTarget.length > 0) {
    el.textContent = `å‰å›: ${lastManualTarget.map(a => normalizeDisplayName(a, null)).join(', ')}`;
  } else {
    el.textContent = '';
  }
}

// â˜…v17.0.0è¿½åŠ ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€ä¿¡â˜…
function sendManualMessage() {
  const theme = document.getElementById('themeInput').value;
  if (!theme) {
    alert("è­°é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  if (manualSelectedTargets.length === 0) {
    alert("é€ä¿¡å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }
  
  lastManualTarget = [...manualSelectedTargets];
  updateManualSendLastTarget();
  
  // è¿½è³ªå•ã®å ´åˆã€å¼•ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è‡ªå‹•æŒ¿å…¥
  let message = theme;
  if (lastFollowupCard) {
    const quote = lastFollowupCard.content.substring(0, 100) + (lastFollowupCard.content.length > 100 ? '...' : '');
    message = `ã•ã£ãã®å›ç­”ã®ã“ã®ç‚¹ï¼šã€Œ${quote}ã€ã«ã¤ã„ã¦ã€è³ªå•ã—ã¾ã™ã€‚\n\n${theme}`;
    lastFollowupCard = null; // ä¸€åº¦ä½¿ã£ãŸã‚‰ã‚¯ãƒªã‚¢
  }
  
  manualSelectedTargets.forEach(agent => {
    const grid = document.getElementById('manualGrid');
    if (grid.style.display !== 'grid') {
      grid.style.display = 'grid';
      grid.innerHTML = '';
    }
    
    const div = document.createElement('div');
    div.className = 'mini-col';
    const id = `hist-${agent}-${Date.now()}`;
    const displayName = normalizeDisplayName(agent, null);
    div.innerHTML = `<div class="mini-head h-${agent}"><span>${displayName}</span><button class="followup-btn" onclick="setFollowupTarget('${agent}', '${id}')">â†© è¿½è³ªå•</button></div><div class="mini-body" id="${id}"><div style="color:#999;">Thinking...</div></div>`;
    grid.appendChild(div);
    // â˜…v17.0.6-btndead1: å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸè¦ç´ ã®onclickäº’æ›ãƒ¬ã‚¤ãƒ¤ã‚’é©ç”¨â˜…
    __bindOnclickCompat__();
    
    google.script.run.withSuccessHandler(raw => {
      let normalized = null;
      if (typeof raw === "string") {
        try {
          normalized = JSON.parse(raw);
        } catch (e) {
          normalized = { status: "success", response: raw };
        }
      } else if (typeof raw === "object" && raw !== null) {
        normalized = raw;
      } else {
        normalized = { status: "success", response: String(raw || "(ç„¡å¿œç­”)") };
      }
      const responseText = normalized.response || normalized.text || normalized.message || String(normalized || "(ç„¡å¿œç­”)");
      const bodyEl = document.getElementById(id);
      if (bodyEl) {
        bodyEl.innerHTML = formatMarkdown(responseText);
        // â˜…v17.0.0è¿½åŠ ï¼šè¿½è³ªå•ãƒœã‚¿ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰å†…ã«ã‚‚è¿½åŠ â˜…
        const headEl = bodyEl.previousElementSibling;
        if (headEl && !headEl.querySelector('.followup-btn')) {
          const btn = document.createElement('button');
          btn.className = 'followup-btn';
          btn.textContent = 'â†© è¿½è³ªå•';
          btn.onclick = () => setFollowupTarget(agent, id);
          headEl.appendChild(btn);
        }
      }
      saveStorage();
    }).runConferenceTurn(agent, message, message, imagesBase64, sessionId, "", null);
  });
  
  document.getElementById('statusText').innerText = "âœ… é€ä¿¡å®Œäº†";
}

// â˜…v17.0.0è¿½åŠ ï¼šè¿½è³ªå•å¯¾è±¡ã‚’è¨­å®šâ˜…
function setFollowupTarget(agent, cardId) {
  const bodyEl = document.getElementById(cardId);
  if (!bodyEl) return;
  
  const content = bodyEl.textContent || bodyEl.innerText || '';
  lastFollowupCard = {
    agent: agent,
    cardId: cardId,
    content: content
  };
  
  // é€ä¿¡å…ˆã‚’ãã®AIã«å›ºå®š
  manualSelectedTargets = [agent];
  initManualSendTargets();
  
  // å…¥åŠ›æ¬„ã«å¼•ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’è‡ªå‹•æŒ¿å…¥
  const themeInput = document.getElementById('themeInput');
  const quote = content.substring(0, 100) + (content.length > 100 ? '...' : '');
  themeInput.value = `ã•ã£ãã®å›ç­”ã®ã“ã®ç‚¹ï¼šã€Œ${quote}ã€ã«ã¤ã„ã¦ã€è³ªå•ã—ã¾ã™ã€‚\n\n`;
  themeInput.focus();
  
  alert(`${normalizeDisplayName(agent, null)}ã¸ã®è¿½è³ªå•ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
}

function startManual(theme) {
  const grid = document.getElementById('manualGrid');
  grid.style.display = 'grid'; grid.innerHTML = "";
  
  // â˜…ä¿®æ­£â‘ ï¼šselectedãŒç©ºã®å ´åˆã€å…¨å“¡ã‚’é¸æŠï¼ˆAGENTSå…¨éƒ¨ï¼‰â˜…
  // â˜…ä¿®æ­£ï¼šå¸ä¼šAIï¼ˆmcï¼‰ã‚’é™¤å¤–ï¼ˆæ’ä»–åˆ¶å¾¡ï¼‰â˜…
  const mc = document.getElementById('mcSelect').value;
  const targets = (selected.length > 0 ? selected : AGENTS).filter(a => a !== mc);
  
  // â˜…v17.0.0ä¿®æ­£ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€ä¿¡å…ˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨â˜…
  const sendTargets = manualSelectedTargets.length > 0 ? manualSelectedTargets.filter(a => a !== mc) : targets;
  
  const cols = Math.min(sendTargets.length, 4);
  grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  sendTargets.forEach(a => {
    const div = document.createElement('div'); div.className = 'mini-col';
    const id = `hist-${a}-${Date.now()}`;
    const displayName = normalizeDisplayName(a, null);
    div.innerHTML = `<div class="mini-head h-${a}"><span>${displayName}</span><button class="followup-btn" onclick="setFollowupTarget('${a}', '${id}')">â†© è¿½è³ªå•</button></div><div class="mini-body" id="${id}"><div style="color:#999;">Thinking...</div></div>`;
    grid.appendChild(div);
    // â˜…v17.0.6-btndead1: å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸè¦ç´ ã®onclickäº’æ›ãƒ¬ã‚¤ãƒ¤ã‚’é©ç”¨â˜…
    __bindOnclickCompat__();
    google.script.run.withSuccessHandler(raw => {
      // â˜…ä¿®æ­£â‘¡ï¼šè¿”ã‚Šå€¤ã‚’æ­£è¦åŒ–ï¼ˆstring/objectã®æºã‚Œã‚’å¸åï¼‰â˜…
      let normalized = null;
      if (typeof raw === "string") {
        try {
          normalized = JSON.parse(raw);
        } catch (e) {
          normalized = { status: "success", response: raw };
        }
      } else if (typeof raw === "object" && raw !== null) {
        normalized = raw;
      } else {
        normalized = { status: "success", response: String(raw || "(ç„¡å¿œç­”)") };
      }
      const responseText = normalized.response || normalized.text || normalized.message || String(normalized || "(ç„¡å¿œç­”)");
      const bodyEl = document.getElementById(id);
      if (bodyEl) {
        bodyEl.innerHTML = formatMarkdown(responseText);
        // â˜…v17.0.0è¿½åŠ ï¼šè¿½è³ªå•ãƒœã‚¿ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰å†…ã«ã‚‚è¿½åŠ â˜…
        const headEl = bodyEl.previousElementSibling;
        if (headEl && !headEl.querySelector('.followup-btn')) {
          const btn = document.createElement('button');
          btn.className = 'followup-btn';
          btn.textContent = 'â†© è¿½è³ªå•';
          btn.onclick = () => setFollowupTarget(a, id);
          headEl.appendChild(btn);
        }
      }
      saveStorage();
    }).runConferenceTurn(a, theme, theme, imagesBase64, sessionId, "", null);
  });
  document.getElementById('statusText').innerText = "âœ… å®Œäº†";
}

function openCode(i) {
  const s = codeSnippets[i]; const el = document.getElementById('codeViewerContent');
  el.textContent = s.c; el.className = `language-${s.l}`; 
  if (typeof hljs !== 'undefined' && hljs) {
    hljs.highlightElement(el);
  }
  openModal('codeModal');
}
function copyCode() { 
  const el = document.getElementById('codeViewerContent');
  if (el) {
    navigator.clipboard.writeText(el.textContent).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")); 
  }
}
function uploadCode(){
  const c = document.getElementById('themeInput').value;
  if(c) {
    google.script.run.withSuccessHandler(alert).uploadToGithub(prompt("File?","Code.gs"),c);
  }
}

// Image Handling
async function handleFileSelect(e){
  const f = Array.from(e.target.files);
  for(const x of f){
    const c = await compress(x);
    if (c) {
      imagesBase64.push(c);
      const wrapper = document.createElement('div');
      wrapper.className = 'preview-wrapper';
      wrapper.innerHTML = `<img src="${c}" class="preview-thumb"><div class="preview-popup"><img src="${c}"></div>`;
      document.getElementById('previewArea').appendChild(wrapper);
    }
  }
}
function compress(b){
  return new Promise(r=>{
    const f = new FileReader();
    f.onload = e => {
      const i = new Image();
      i.onload = () => {
        const c = document.createElement('canvas');
        let w = i.width, h = i.height;
        if(w > 1000 || h > 1000) {
          const s = Math.min(1000/w, 1000/h);
          w *= s; h *= s;
        }
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(i, 0, 0, w, h);
        r(c.toDataURL('image/jpeg', 0.7));
      };
      i.src = e.target.result;
    };
    f.readAsDataURL(b);
  });
}
async function pasteFromClipboard(){
  try {
    const i = await navigator.clipboard.read();
    for(const x of i){
      const t = x.types.find(a => a.startsWith('image/'));
      if(t){
        const b = await x.getType(t);
        const c = await compress(b);
        if (c) {
          imagesBase64.push(c);
          const w = document.createElement('div');
          w.className = 'preview-wrapper';
          w.innerHTML = `<img src="${c}" class="preview-thumb"><div class="preview-popup"><img src="${c}"></div>`;
          document.getElementById('previewArea').appendChild(w);
        }
      }
    }
  } catch (e) {
    console.warn('Clipboard read failed:', e);
  }
}

function saveStorage(){
  try {
    localStorage.setItem(STORAGE_KEY, document.getElementById('mainStage').innerHTML);
  } catch (e) {
    console.warn('saveStorage failed:', e);
  }
}

// â˜…ä¿®æ­£ï¼šéå»ãƒ­ã‚°è¡¨ç¤ºã‚’timeline-cardã§å†æç”»â˜…
function openHistoryModal(){
  openModal('historyModal');
  google.script.run.withSuccessHandler(l=>{
    let list = l;
    if (typeof l === "string") {
      try { list = JSON.parse(l); } catch (e) { list = []; }
    }
    if (!Array.isArray(list)) list = [];
    
    if (!list.length) {
      document.getElementById('logList').innerHTML = "<div style='padding:20px;text-align:center;color:#64748b;'>ä¿å­˜æ¸ˆã¿ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
      return;
    }
    
    // â˜…v16.3.8-hf1ä¿®æ­£ï¼šãƒ­ã‚°ãƒªãƒ³ã‚¯ï¼ˆURL/ãƒ•ã‚¡ã‚¤ãƒ«IDãŒå–ã‚Œãªã„æ™‚ã¯é·ç§»ã—ãªã„ã€å¯èƒ½ãªã‚‰æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãï¼‰â˜…
    // â˜…v17.0.0ä¿®æ­£ï¼šãƒ­ã‚°ä¸€è¦§ã«æ—¥ä»˜ã‚’è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è­°é¡Œã®å¾©å…ƒç¢ºèªï¼‰â˜…
    document.getElementById('logList').innerHTML = list.map(x=>{
      // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆtimeãŒDateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯å¤‰æ›ï¼‰
      let dateStr = '';
      if (x.time) {
        if (x.time instanceof Date) {
          const d = x.time;
          dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        } else if (x.date) {
          // dateãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆ
          if (x.date instanceof Date) {
            const d = x.date;
            dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
          } else {
            dateStr = String(x.date);
          }
        } else {
          dateStr = String(x.time);
        }
      }
      const displayText = dateStr ? `${dateStr} - ${x.title||'(ç„¡é¡Œ)'}` : `${x.time || ''} ${x.title||'(ç„¡é¡Œ)'}`;
      
      const hasUrl = x.url && x.url.trim() && x.url.trim() !== '';
      const hasFileId = x.fileId && x.fileId.trim() && x.fileId.trim() !== '';
      if (hasUrl || hasFileId) {
        const url = hasUrl ? x.url : `https://drive.google.com/file/d/${x.fileId}/view`;
        return `<div class="log-item"><div class="log-text" onclick="window.open('${url}', '_blank')">${displayText}</div><button class="log-del-btn" onclick="deleteLog('${x.id}',this)">å‰Šé™¤</button></div>`;
      } else {
        return `<div class="log-item"><div class="log-text" onclick="loadLog('${x.id}')">${displayText}</div><button class="log-del-btn" onclick="deleteLog('${x.id}',this)">å‰Šé™¤</button></div>`;
      }
            }).join('');
            // â˜…v17.0.4-btnfix3: å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸè¦ç´ ã®onclickå±æ€§ã‚’removeã—ã¦addEventListenerã§ä»˜ã‘ç›´ã™â˜…
            _replaceOnclickWithListeners_();
          }).withFailureHandler(err=>{
            document.getElementById('logList').innerHTML = `<div style='padding:20px;text-align:center;color:#ef4444;'>å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${err?.message || err}</div>`;
          }).getLogList();
}

function closeHistoryModal(){
  closeModal('historyModal');
}

// â˜…è¿½åŠ ï¼šè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãâ˜…
function openSettingsModal() {
  applySettingsToUI(); // UIã«ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
  openModal('settingsModal');
}

// â˜…è¿½åŠ ï¼šè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹â˜…
function closeSettingsModal() {
  closeModal('settingsModal');
}

// â˜…è¿½åŠ ï¼šè¨­å®šã‚’UIã«åæ˜ â˜…
function applySettingsToUI() {
  document.getElementById('settingSummaryLevel').value = settings.summaryLevel;
  document.getElementById('settingConversationTone').value = settings.conversationTone;
  document.getElementById('settingPoliteSuppress').checked = settings.politeSuppress;
  document.getElementById('settingIndicatorMode').value = settings.indicatorMode || 'text';
  document.getElementById('settingResponseDetail').value = settings.responseDetail || 'standard';
  document.getElementById('indicatorThinking').checked = settings.indicators.thinking;
  document.getElementById('indicatorTimeout').checked = settings.indicators.timeout;
  document.getElementById('indicatorCut').checked = settings.indicators.cut;
  document.getElementById('indicatorLate').checked = settings.indicators.late;
  document.getElementById('indicatorError').checked = settings.indicators.error;
  
  // â˜…v17.0.0è¿½åŠ ï¼šã‚«ã‚¹ã‚¿ãƒ åã‚’UIã«åæ˜ â˜…
  AGENTS.forEach(agent => {
    const inputEl = document.getElementById(`customName-${agent}`);
    if (inputEl && settings.customNames && settings.customNames[agent]) {
      inputEl.value = settings.customNames[agent];
    } else if (inputEl) {
      inputEl.value = '';
    }
  });
}

// â˜…è¿½åŠ ï¼šè¨­å®šã‚’ä¿å­˜ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹â˜…
function saveSettingsAndClose() {
  settings.summaryLevel = document.getElementById('settingSummaryLevel').value;
  settings.conversationTone = document.getElementById('settingConversationTone').value;
  settings.politeSuppress = document.getElementById('settingPoliteSuppress').checked;
  settings.indicatorMode = document.getElementById('settingIndicatorMode').value;
  settings.responseDetail = document.getElementById('settingResponseDetail').value;
  settings.indicators.thinking = document.getElementById('indicatorThinking').checked;
  settings.indicators.timeout = document.getElementById('indicatorTimeout').checked;
  settings.indicators.cut = document.getElementById('indicatorCut').checked;
  settings.indicators.late = document.getElementById('indicatorLate').checked;
  settings.indicators.error = document.getElementById('indicatorError').checked;
  
  // â˜…v17.0.0è¿½åŠ ï¼šã‚«ã‚¹ã‚¿ãƒ åã‚’ä¿å­˜â˜…
  if (!settings.customNames) settings.customNames = {};
  AGENTS.forEach(agent => {
    const inputEl = document.getElementById(`customName-${agent}`);
    if (inputEl) {
      const customName = inputEl.value.trim();
      if (customName) {
        settings.customNames[agent] = customName;
      } else {
        delete settings.customNames[agent];
      }
    }
  });
  
  saveSettings();
  closeSettingsModal();
}

// â˜…è¿½åŠ ï¼šè¦ç´„ãƒ¬ãƒ™ãƒ«ã¨ä¼šè©±ãƒˆãƒ¼ãƒ³ã‚’instrã«ä»˜ä¸ã™ã‚‹é–¢æ•°â˜…
function _applySettingsToInstruction_(baseInstr) {
  let tags = [];
  
  // â˜…v17.0.0ä¿®æ­£ï¼šå›ç­”ã®è©³ã—ã•ï¼ˆã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ã€responseDetailã‚’å„ªå…ˆï¼‰â˜…
  const responseDetail = settings.responseDetail || settings.summaryLevel || 'standard';
  if (responseDetail === 'simple') {
    tags.push('[å›ç­”ã®è©³ã—ã•:ç°¡å˜] è¦ç‚¹ã®ã¿ï¼ˆç®‡æ¡æ›¸ãä¸­å¿ƒã€çŸ­ã‚ï¼‰ã€‚æœ€å¾Œã«ã€Œä»¥ä¸Šã€ã§ç· ã‚ã‚‹ã“ã¨ã€‚');
  } else if (responseDetail === 'standard') {
    tags.push('[å›ç­”ã®è©³ã—ã•:æ¨™æº–] è¦ç‚¹ï¼‹ç†ç”±ï¼‹æ¬¡ã®æ‰‹ã€‚æœ€å¾Œã«ã€Œä»¥ä¸Šã€ã§ç· ã‚ã‚‹ã“ã¨ã€‚');
  } else if (responseDetail === 'detailed') {
    tags.push('[å›ç­”ã®è©³ã—ã•:è©³ç´°] æ‰‹é †ãƒ»æ³¨æ„ç‚¹ãƒ»ä»£æ›¿æ¡ˆã¾ã§ã€‚æœ€å¾Œã«ã€Œä»¥ä¸Šã€ã§ç· ã‚ã‚‹ã“ã¨ã€‚');
  }
  
  // è¦ç´„ãƒ¬ãƒ™ãƒ«ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ç¶­æŒï¼‰
  if (settings.summaryLevel === 'simple') {
    tags.push('[è¦ç´„:ç°¡å˜] çµè«–â†’ç®‡æ¡æ›¸ã3ã¤â†’æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³');
  } else if (settings.summaryLevel === 'standard') {
    tags.push('[è¦ç´„:æ¨™æº–] çµè«–â†’ç†ç”±â†’æ‰‹é †');
  } else if (settings.summaryLevel === 'detailed') {
    tags.push('[è¦ç´„:è©³ç´°] å‰æâ†’åˆ¤æ–­â†’æ‰‹é †â†’æ³¨æ„ç‚¹');
  }
  
  // ä¼šè©±ãƒˆãƒ¼ãƒ³
  if (settings.conversationTone === 'first') {
    tags.push('[ãƒˆãƒ¼ãƒ³:åˆã‚ã¦] ä¸å¯§ã‚');
  } else if (settings.conversationTone === 'friendly') {
    tags.push('[ãƒˆãƒ¼ãƒ³:ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼] æŸ”ã‚‰ã‹ã‚ï¼ˆç •ã‘ã™ãç¦æ­¢ï¼‰');
  } else if (settings.conversationTone === 'business') {
    tags.push('[ãƒˆãƒ¼ãƒ³:ä»•äº‹] ç”¨ä»¶ä¸­å¿ƒã§çŸ­ã');
  }
  
  // ä¸å¯§ã™ãæŠ‘åˆ¶
  if (settings.politeSuppress) {
    tags.push('[ä¸å¯§æŠ‘åˆ¶ON] å‰ç½®ããƒ»æŒ¨æ‹¶ã‚’å‰Šã‚‹');
  }
  
  if (tags.length > 0) {
    return baseInstr + '\n\nã€é‹ç”¨ã‚¿ã‚°ã€‘\n' + tags.join('\n');
  }
  return baseInstr;
}

// â˜…v17.0.0ä¿®æ­£ï¼šloadLog()ã‚’timeline-cardã§å†æç”»ã€è­°é¡Œ/ã‚¿ã‚¤ãƒˆãƒ«/ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã‚‚å¾©å…ƒâ˜…
function loadLog(sessionId){
  if(!sessionId) return;
  if(!confirm("éå»ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ")) return;
  
  closeHistoryModal();
  
  google.script.run
    .withSuccessHandler((result) => {
      // â˜…v17.0.0ä¿®æ­£ï¼šresultãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€logsã¨metadataã‚’åˆ†é›¢â˜…
      let arr = [];
      let metadata = null;
      
      if (typeof result === "string") {
        try { 
          const parsed = JSON.parse(result);
          if (Array.isArray(parsed)) {
            arr = parsed;
          } else if (parsed.logs && Array.isArray(parsed.logs)) {
            arr = parsed.logs;
            metadata = parsed.metadata || null;
          }
        } catch (e) { 
          arr = []; 
        }
      } else if (typeof result === "object" && result !== null) {
        if (Array.isArray(result)) {
          arr = result;
        } else if (result.logs && Array.isArray(result.logs)) {
          arr = result.logs;
          metadata = result.metadata || null;
        }
      }
      
      if (!Array.isArray(arr)) arr = [];
      
      if (arr.length === 0) {
        alert("ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      
      // â˜…v17.0.0è¿½åŠ ï¼šè­°é¡Œ/ã‚¿ã‚¤ãƒˆãƒ«/ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã‚’å¾©å…ƒâ˜…
      if (metadata) {
        if (metadata.title) {
          document.getElementById('topicTitle').value = metadata.title;
        }
        if (metadata.theme) {
          document.getElementById('themeInput').value = metadata.theme;
        }
        if (metadata.mode) {
          setMode(metadata.mode);
        }
      }
      
      // â˜…ä¿®æ­£ï¼šæ—¢å­˜ã®timelineã«å†æç”»ï¼ˆmanual-gridã§ã¯ãªãï¼‰â˜…
      const tl = document.getElementById('timeline');
      if (!tl) {
        alert("ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
      }
      
      tl.innerHTML = ""; // ã‚¯ãƒªã‚¢
      
      arr.forEach((log) => {
        const speaker = String(log.speaker || "unknown");
        const content = String(log.content || "");
        const time = String(log.time || "");
        
        // è¡¨ç¤ºåã®æ­£è¦åŒ–ï¼ˆv17.0.0ï¼šå›ºå®šåã®ã¿ï¼‰
        const displayName = normalizeDisplayName(speaker, null);
        
        // å½¹å‰²ãƒãƒƒã‚¸ã®åˆ¤å®šï¼ˆç°¡æ˜“ç‰ˆï¼‰
        let roleBadge = "";
        let roleClass = "";
        const lowerSpeaker = speaker.toLowerCase();
        if (lowerSpeaker.includes('proposer') || assignedRoles[speaker] === 'proposer') {
          roleBadge = '<span class="role-badge" style="background:var(--role-proposer);">ææ¡ˆ</span>';
          roleClass = 'role-proposer';
        } else if (lowerSpeaker.includes('opposer') || assignedRoles[speaker] === 'opposer') {
          roleBadge = '<span class="role-badge" style="background:var(--role-opposer);">åè«–</span>';
          roleClass = 'role-opposer';
        } else if (lowerSpeaker.includes('tech') || assignedRoles[speaker] === 'tech') {
          roleBadge = '<span class="role-badge" style="background:var(--role-tech);">æŠ€è¡“</span>';
          roleClass = 'role-tech';
        } else if (lowerSpeaker === 'yui' || lowerSpeaker.includes('mc')) {
          roleBadge = '<span class="role-badge" style="background:#64748b;">å¸ä¼š</span>';
        }
        
        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        const card = document.createElement('div');
        card.className = `timeline-card ${roleClass}`;
        card.innerHTML = `
          <div class="tl-header h-${speaker.toLowerCase()}">
            <span>${displayName} ${roleBadge}</span>
            <span>${time}</span>
          </div>
          <div class="tl-body">${formatMarkdown(content)}</div>
        `;
        tl.appendChild(card);
      });
      
      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
      document.getElementById('mainStage').style.display = 'block';
      document.getElementById('progressZone').style.display = 'none';
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      window.scrollTo(0, document.body.scrollHeight);
      
      document.getElementById('statusText').innerText = "éå»ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ";
      document.getElementById('statusText').style.color = '#10b981';
    })
    .withFailureHandler((err) => {
      alert("ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: " + (err?.message || err));
    })
    .getSessionLogs(sessionId);
}

function deleteLog(id, btn){
  if(!id) return;
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  google.script.run.withSuccessHandler(r=>{
    if(r.success && btn) {
      btn.parentElement.remove();
    }
  }).deleteLog(id);
}

// â˜…v17.0.4-btnfix3: onclickå±æ€§ã‚’removeã—ã¦addEventListenerã§ä»˜ã‘ç›´ã™ï¼ˆUIå·®åˆ†ã‚¼ãƒ­ãƒ»æœ€å°ã§å¼·ã„ï¼‰â˜…
// â˜…v17.0.6-btndead1: onclickäº’æ›ãƒ¬ã‚¤ãƒ¤ï¼ˆevalç¦æ­¢ãƒ»æ­£è¦è¡¨ç¾è§£ææ–¹å¼ï¼‰â˜…
// â˜…v17.0.7-upload-btndead: ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®çµã³ã¤ãã‚’ç¢ºå®Ÿã«ãƒ‡ãƒãƒƒã‚°â˜…
function __bindOnclickCompat__() {
  try {
    const elements = document.querySelectorAll('[onclick]');
    const debugMode = new URLSearchParams(window.location.search).get('debug') === '1';
    let bindCount = 0;
    let lastClick = null;
    let lastError = null;
    const bindInfo = []; // debug=1æ™‚ç”¨ï¼šãƒãƒ³ãƒ‰ãƒ©çµã³ã¤ãæƒ…å ±
    
    elements.forEach(el => {
      const onclickValue = el.getAttribute('onclick');
      if (!onclickValue || !onclickValue.trim()) return;
      
      const elInfo = `${el.tagName}${el.id ? `#${el.id}` : ''}${el.className ? `.${el.className.split(' ')[0]}` : ''}`;
      
      // onclickå±æ€§ã‚’removeï¼ˆHTMLã«ã¯æ®‹ã—ãŸã¾ã¾ã€å‹•ä½œã¯ç„¡åŠ¹åŒ–ï¼‰
      el.removeAttribute('onclick');
      
      // addEventListenerã§handlerã‚’ä»˜ã‘ç›´ã™
      const handler = (e) => {
        e.preventDefault();
        e.stopPropagation();
        lastClick = onclickValue;
        
        if (debugMode) {
          console.log('[onclickäº’æ›ãƒ¬ã‚¤ãƒ¤] ã‚¯ãƒªãƒƒã‚¯ç™ºç«:', elInfo, onclickValue);
        }
        
        // â˜…v17.0.6-btndead1: debug=1æ™‚ã®ã¿ã€ã‚¯ãƒªãƒƒã‚¯ãŒå±Šã„ã¦ã„ãªã„å¯èƒ½æ€§ã®åˆ‡ã‚Šåˆ†ã‘â˜…
        if (debugMode) {
          const clickedEl = document.elementFromPoint(e.clientX, e.clientY);
          if (clickedEl && clickedEl !== el) {
            const tagInfo = clickedEl.tagName + (clickedEl.id ? `#${clickedEl.id}` : '') + (clickedEl.className ? `.${clickedEl.className.split(' ')[0]}` : '');
            console.warn('[onclickäº’æ›ãƒ¬ã‚¤ãƒ¤] ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã®è¦ç´ ãŒç•°ãªã‚‹:', tagInfo);
            if (lastError) {
              lastError += ` | è¢«ã›è¦ç´ : ${tagInfo}`;
            }
          }
        }
        
        try {
          __invokeOnclickString__(onclickValue);
        } catch (err) {
          lastError = err.message || String(err);
          console.error('[onclickäº’æ›ãƒ¬ã‚¤ãƒ¤] handler error:', err, 'onclick value:', onclickValue, 'element:', elInfo);
          if (debugMode) {
            _updateDebugLog_('onclick', bindCount, lastClick, lastError);
          }
        }
      };
      
      el.addEventListener('click', handler);
      bindCount++;
      
      // debug=1æ™‚ï¼šãƒãƒ³ãƒ‰ãƒ©çµã³ã¤ãæƒ…å ±ã‚’è¨˜éŒ²
      if (debugMode) {
        bindInfo.push({ element: elInfo, onclick: onclickValue, hasHandler: true });
      }
    });
    
    if (debugMode) {
      console.log(`[onclickäº’æ›ãƒ¬ã‚¤ãƒ¤] ãƒã‚¤ãƒ³ãƒ‰å®Œäº†: ${bindCount}å€‹ã®è¦ç´ ã«ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š`);
      if (bindInfo.length > 0) {
        console.table(bindInfo);
      }
      _updateDebugLog_('onclick', bindCount, lastClick, lastError, `ãƒãƒ³ãƒ‰ãƒ©çµã³ã¤ã: ${bindCount}å€‹`);
    }
  } catch (e) {
    console.error('__bindOnclickCompat__ error:', e);
    const debugMode = new URLSearchParams(window.location.search).get('debug') === '1';
    if (debugMode) {
      const debugDiv = document.getElementById('debug-console');
      if (debugDiv) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'margin-top:8px;padding:6px;background:rgba(255,0,0,0.2);border:1px solid #f00;border-radius:4px;font-size:11px;';
        errorDiv.innerHTML = `<strong>âŒ __bindOnclickCompat__åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</strong><br>${e.message}`;
        debugDiv.appendChild(errorDiv);
      }
    }
  }
}

// â˜…v17.0.6-btndead1: onclickæ–‡å­—åˆ—ã‚’æ­£è¦è¡¨ç¾ã§è§£æã—ã¦å®Ÿè¡Œï¼ˆevalç¦æ­¢ï¼‰â˜…
function __invokeOnclickString__(code) {
  code = code.trim();
  
  // ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ï¼ˆä¾‹ï¼šdocument.getElementById('fileInput').click()ï¼‰ã®ç‰¹åˆ¥å‡¦ç†
  if (code.includes('.') && !code.startsWith('window.') && !code.startsWith('globalThis.')) {
    // ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã¯evalã‚’ä½¿ã‚ãšã€ç°¡æ˜“ãƒ‘ãƒ¼ã‚µã§å‡¦ç†
    // ä¾‹: document.getElementById('fileInput').click()
    const match = code.match(/^([a-zA-Z_$][a-zA-Z0-9_$]*(\.[a-zA-Z_$][a-zA-Z0-9_$]*)*)\((.*)\)$/);
    if (match) {
      const objPath = match[1];
      const argsStr = match[3];
      const parts = objPath.split('.');
      let obj = window;
      for (let i = 0; i < parts.length - 1; i++) {
        obj = obj[parts[i]];
        if (!obj) throw new Error(`Property ${parts[i]} not found`);
      }
      const methodName = parts[parts.length - 1];
      const args = _parseArguments_(argsStr);
      if (typeof obj[methodName] === 'function') {
        return obj[methodName].apply(obj, args);
      } else {
        throw new Error(`Method ${methodName} is not a function`);
      }
    }
    // ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã¯ã‚¨ãƒ©ãƒ¼
    throw new Error(`Unsupported method chain: ${code}`);
  }
  
  // é€šå¸¸ã®é–¢æ•°å‘¼ã³å‡ºã—ï¼ˆä¾‹ï¼šsetMode('auto')ï¼‰
  const match = code.match(/^([a-zA-Z_$][a-zA-Z0-9_$]*)\((.*)\)$/);
  if (!match) {
    throw new Error(`Invalid function call format: ${code}`);
  }
  
  const funcName = match[1];
  const argsStr = match[2];
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰é–¢æ•°ã‚’å–å¾—
  const func = globalThis[funcName] || window[funcName];
  if (typeof func !== 'function') {
    throw new Error(`Function ${funcName} is not defined`);
  }
  
  // å¼•æ•°ã‚’ãƒ‘ãƒ¼ã‚¹
  const args = _parseArguments_(argsStr);
  
  // é–¢æ•°ã‚’å®Ÿè¡Œ
  return func.apply(null, args);
}

// â˜…v17.0.6-btndead1: å¼•æ•°æ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆæ–‡å­—åˆ—/æ•°å€¤/true/false/null/undefinedã®ã¿å¯¾å¿œï¼‰â˜…
function _parseArguments_(argsStr) {
  if (!argsStr || !argsStr.trim()) {
    return [];
  }
  
  const args = [];
  let current = '';
  let inString = false;
  let stringChar = '';
  let depth = 0;
  
  for (let i = 0; i < argsStr.length; i++) {
    const char = argsStr[i];
    
    if (!inString && (char === '"' || char === "'")) {
      inString = true;
      stringChar = char;
      current += char;
    } else if (inString && char === stringChar && argsStr[i - 1] !== '\\') {
      inString = false;
      current += char;
    } else if (!inString && char === '(') {
      depth++;
      current += char;
    } else if (!inString && char === ')') {
      depth--;
      current += char;
    } else if (!inString && depth === 0 && char === ',') {
      args.push(_parseSingleArg_(current.trim()));
      current = '';
    } else {
      current += char;
    }
  }
  
  if (current.trim()) {
    args.push(_parseSingleArg_(current.trim()));
  }
  
  return args;
}

// â˜…v17.0.6-btndead1: å˜ä¸€å¼•æ•°ã‚’ãƒ‘ãƒ¼ã‚¹â˜…
function _parseSingleArg_(arg) {
  arg = arg.trim();
  
  // æ–‡å­—åˆ—ï¼ˆ'"'ã§å›²ã¾ã‚Œã¦ã„ã‚‹ï¼‰
  if ((arg.startsWith('"') && arg.endsWith('"')) || (arg.startsWith("'") && arg.endsWith("'"))) {
    return arg.slice(1, -1).replace(/\\(.)/g, '$1'); // ç°¡æ˜“ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
  }
  
  // æ•°å€¤
  if (/^-?\d+(\.\d+)?$/.test(arg)) {
    return parseFloat(arg);
  }
  
  // çœŸå½å€¤
  if (arg === 'true') return true;
  if (arg === 'false') return false;
  
  // null
  if (arg === 'null') return null;
  
  // undefined
  if (arg === 'undefined') return undefined;
  
  // ãã‚Œä»¥å¤–ï¼ˆè¤‡é›‘å¼ãƒ»é€£çµãƒ»ä¸‰é …ãªã©ï¼‰ã¯æœªå¯¾å¿œ
  throw new Error(`Unsupported argument format: ${arg}`);
}

// â˜…v17.0.6-btndead1: debug=1æ™‚ã®ãƒ­ã‚°æ›´æ–°â˜…
function _updateDebugLog_(type, bindCount, lastClick, lastError, elementInfo = '') {
  const debugDiv = document.getElementById('debug-console');
  if (!debugDiv) return;
  
  const info = document.createElement('div');
  info.style.cssText = 'margin-top:10px;padding:8px;background:rgba(0,255,0,0.1);border:1px solid #0f0;border-radius:4px;';
  info.innerHTML = `
    <strong>onclickäº’æ›ãƒ¬ã‚¤ãƒ¤</strong><br>
    ãƒã‚¤ãƒ³ãƒ‰æ•°: ${bindCount}<br>
    æœ€å¾Œã®ã‚¯ãƒªãƒƒã‚¯: ${lastClick || '(ãªã—)'}<br>
    æœ€å¾Œã®ã‚¨ãƒ©ãƒ¼: ${lastError || '(ãªã—)'}
    ${elementInfo ? `<br>${elementInfo}` : ''}
  `;
  
  // æ—¢å­˜ã®onclickæƒ…å ±ã‚’å‰Šé™¤
  const existing = debugDiv.querySelector('[data-onclick-info]');
  if (existing) existing.remove();
  
  info.setAttribute('data-onclick-info', '1');
  debugDiv.appendChild(info);
}

// â˜…v17.0.7-upload-btndead: debug=1æ™‚ã®ã¿ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚­ãƒ£ãƒ—ãƒãƒ£ã§åŸå› åˆ‡ã‚Šåˆ†ã‘â˜…
function __initClickObserver__() {
  const debugMode = new URLSearchParams(window.location.search).get('debug') === '1';
  if (!debugMode) return;
  
  let clickLog = [];
  const MAX_LOG = 10;
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚¯ãƒªãƒƒã‚¯ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒªã‚¹ãƒŠãƒ¼ï¼ˆcapture: trueã§å…¨ã‚¯ãƒªãƒƒã‚¯ã‚’æ•æ‰ï¼‰
  document.addEventListener('click', (e) => {
    const target = e.target;
    const path = e.composedPath ? Array.from(e.composedPath()) : [target];
    
    // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã®è¦ç´ ã‚’å–å¾—
    const clickedEl = document.elementFromPoint(e.clientX, e.clientY);
    const targetInfo = target ? `${target.tagName}${target.id ? `#${target.id}` : ''}${target.className ? `.${target.className.split(' ')[0]}` : ''}` : '(null)';
    const clickedInfo = clickedEl ? `${clickedEl.tagName}${clickedEl.id ? `#${clickedEl.id}` : ''}${clickedEl.className ? `.${clickedEl.className.split(' ')[0]}` : ''}` : '(null)';
    
    // pointer-eventsã€z-indexã€positionã‚’ç¢ºèª
    const computed = window.getComputedStyle(target);
    const pointerEvents = computed.pointerEvents;
    const zIndex = computed.zIndex;
    const position = computed.position;
    const display = computed.display;
    const visibility = computed.visibility;
    const opacity = computed.opacity;
    
    const logEntry = {
      time: new Date().toLocaleTimeString('ja-JP'),
      target: targetInfo,
      clicked: clickedInfo,
      isSame: target === clickedEl,
      pointerEvents,
      zIndex,
      position,
      display,
      visibility,
      opacity,
      hasOnclick: target && target.hasAttribute('onclick'),
      pathLength: path.length
    };
    
    clickLog.push(logEntry);
    if (clickLog.length > MAX_LOG) clickLog.shift();
    
    // å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã®ã¿ãƒ­ã‚°ã«è¡¨ç¤º
    const hasIssue = !logEntry.isSame || 
                     pointerEvents === 'none' || 
                     display === 'none' || 
                     visibility === 'hidden' || 
                     parseFloat(opacity) < 0.01 ||
                     (target && !target.hasAttribute('onclick') && !target.onclick && !target.closest('button') && !target.closest('a'));
    
    if (hasIssue) {
      const issueInfo = [];
      if (!logEntry.isSame) issueInfo.push(`è¢«ã›è¦ç´ : ${clickedInfo}`);
      if (pointerEvents === 'none') issueInfo.push('pointer-events:none');
      if (display === 'none') issueInfo.push('display:none');
      if (visibility === 'hidden') issueInfo.push('visibility:hidden');
      if (parseFloat(opacity) < 0.01) issueInfo.push(`opacity:${opacity}`);
      
      const debugDiv = document.getElementById('debug-console');
      if (debugDiv) {
        const warnDiv = document.createElement('div');
        warnDiv.style.cssText = 'margin-top:8px;padding:6px;background:rgba(255,165,0,0.2);border:1px solid #ff8c00;border-radius:4px;font-size:11px;';
        warnDiv.innerHTML = `<strong>âš  ã‚¯ãƒªãƒƒã‚¯å•é¡Œæ¤œå‡º</strong><br>${logEntry.time} | ${targetInfo}<br>${issueInfo.join(' | ')}`;
        const existing = debugDiv.querySelector('[data-click-warn]');
        if (existing) existing.remove();
        warnDiv.setAttribute('data-click-warn', '1');
        debugDiv.appendChild(warnDiv);
      }
    }
  }, true); // capture: trueã§å…¨ã‚¯ãƒªãƒƒã‚¯ã‚’æ•æ‰
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®ä¾‹å¤–ã‚’æ•æ‰ï¼‰
  window.addEventListener('error', (event) => {
    if (event.error && event.error.message && event.error.message.includes('onclick')) {
      const debugDiv = document.getElementById('debug-console');
      if (debugDiv) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'margin-top:8px;padding:6px;background:rgba(255,0,0,0.2);border:1px solid #f00;border-radius:4px;font-size:11px;';
        errorDiv.innerHTML = `<strong>âŒ ã‚¯ãƒªãƒƒã‚¯æ™‚ã‚¨ãƒ©ãƒ¼</strong><br>${event.error.message}<br>${event.filename}:${event.lineno}`;
        const existing = debugDiv.querySelector('[data-click-error]');
        if (existing) existing.remove();
        errorDiv.setAttribute('data-click-error', '1');
        debugDiv.appendChild(errorDiv);
      }
    }
  }, true);
}

// â˜…v17.0.4-btnfix3: onclickãŒè¦ªãƒ•ãƒ¬ãƒ¼ãƒ å´ã§è©•ä¾¡ã•ã‚Œã¦ã‚‚å‹•ãã‚ˆã†ã«ã€window/parent/topã¸å®‰å…¨ã«å…¬é–‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ç¶­æŒï¼‰â˜…
(function(){
  const exported = {};
  // â€»typeof æœªå®£è¨€ã§ã‚‚å®‰å…¨ï¼ˆReferenceErrorã«ãªã‚‰ãªã„ï¼‰
  if (typeof setFontSize === 'function') exported.setFontSize = setFontSize;
  if (typeof updateClock === 'function') exported.updateClock = updateClock;
  if (typeof setMode === 'function') exported.setMode = setMode;
  if (typeof openSettingsModal === 'function') exported.openSettingsModal = openSettingsModal;
  if (typeof closeSettingsModal === 'function') exported.closeSettingsModal = closeSettingsModal;
  if (typeof saveSettingsAndClose === 'function') exported.saveSettingsAndClose = saveSettingsAndClose;
  if (typeof applySettingsToUI === 'function') exported.applySettingsToUI = applySettingsToUI;
  if (typeof insertTemplate === 'function') exported.insertTemplate = insertTemplate;
  if (typeof resetInput === 'function') exported.resetInput = resetInput;
  if (typeof pasteFromClipboard === 'function') exported.pasteFromClipboard = pasteFromClipboard;
  if (typeof handleFileSelect === 'function') exported.handleFileSelect = handleFileSelect;
  if (typeof uploadCode === 'function') exported.uploadCode = uploadCode;
  if (typeof startProcess === 'function') exported.startProcess = startProcess;
  if (typeof startAuto === 'function') exported.startAuto = startAuto;
  if (typeof startManual === 'function') exported.startManual = startManual;
  if (typeof sendManualMessage === 'function') exported.sendManualMessage = sendManualMessage;
  if (typeof selectAllManualTargets === 'function') exported.selectAllManualTargets = selectAllManualTargets;
  if (typeof clearManualTargets === 'function') exported.clearManualTargets = clearManualTargets;
  if (typeof toggleManualTarget === 'function') exported.toggleManualTarget = toggleManualTarget;
  if (typeof setFollowupTarget === 'function') exported.setFollowupTarget = setFollowupTarget;
  if (typeof openModal === 'function') exported.openModal = openModal;
  if (typeof closeModal === 'function') exported.closeModal = closeModal;
  if (typeof openHistoryModal === 'function') exported.openHistoryModal = openHistoryModal;
  if (typeof closeHistoryModal === 'function') exported.closeHistoryModal = closeHistoryModal;
  if (typeof tryReset === 'function') exported.tryReset = tryReset;
  if (typeof performReset === 'function') exported.performReset = performReset;
  if (typeof loadLog === 'function') exported.loadLog = loadLog;
  if (typeof deleteLog === 'function') exported.deleteLog = deleteLog;
  if (typeof openCode === 'function') exported.openCode = openCode;
  if (typeof copyCode === 'function') exported.copyCode = copyCode;

  function exposeTo(target){
    if (!target) return;
    try {
      Object.keys(exported).forEach(k => {
        try { target[k] = exported[k]; } catch(e) {}
      });
    } catch(e) {}
  }

  // åŒä¸€ãƒ•ãƒ¬ãƒ¼ãƒ 
  exposeTo(window);
  // è¦ª/æœ€ä¸Šä½ï¼ˆGASã®ãƒ©ãƒƒãƒ‘ãƒ¼å´ã§onclickãŒè©•ä¾¡ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹å¯¾ç­–ï¼‰
  try { if (window.parent && window.parent !== window) exposeTo(window.parent); } catch(e) {}
  try { if (window.top && window.top !== window) exposeTo(window.top); } catch(e) {}

  window.__AI_ROOM_EXPOSED__ = Object.keys(exported);
})();

// â˜…v17.0.6-btndead1: æ˜ç¤ºçš„ãªã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ï¼ˆä¿é™ºãƒ»Object.assignæ–¹å¼ï¼‰â˜…
(function(){
  try {
    // onclick="..."ã§å‘¼ã°ã‚Œã‚‹é–¢æ•°ã‚’å…¨ã¦globalThisã«æ˜ç¤ºçš„ã«å…¬é–‹
    Object.assign(globalThis, {
      setFontSize, updateClock, setMode, openSettingsModal, closeSettingsModal,
      saveSettingsAndClose, applySettingsToUI, insertTemplate, resetInput,
      pasteFromClipboard, handleFileSelect, uploadCode, startProcess,
      startAuto, startManual, sendManualMessage, selectAllManualTargets,
      clearManualTargets, toggleManualTarget, setFollowupTarget,
      openModal, closeModal, openHistoryModal, closeHistoryModal,
      tryReset, performReset, loadLog, deleteLog, openCode, copyCode
    });
  } catch (e) {
    console.error('Object.assign(globalThis, ...) error:', e);
  }
})();

// â˜…v17.0.0-fix: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆç”»é¢å†…ãƒ‡ãƒãƒƒã‚°æ¬„ã¸ã®å‡ºåŠ›ï¼‰â˜…
(function() {
  const debugMode = new URLSearchParams(window.location.search).get('debug') === '1';
  if (!debugMode) return;
  
  // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä½œæˆ
  const debugDiv = document.createElement('div');
  debugDiv.id = 'debug-console';
  debugDiv.style.cssText = 'position:fixed;bottom:10px;right:10px;width:400px;max-height:300px;background:rgba(0,0,0,0.9);color:#0f0;padding:10px;border-radius:8px;font-family:monospace;font-size:11px;overflow-y:auto;z-index:10000;display:none;';
  document.body.appendChild(debugDiv);
  
  function addDebugLog(type, message, error) {
    if (!debugDiv) return;
    debugDiv.style.display = 'block';
    const time = new Date().toLocaleTimeString('ja-JP');
    const logEntry = document.createElement('div');
    logEntry.style.cssText = 'margin-bottom:4px;padding:4px;border-left:3px solid ' + 
      (type === 'error' ? '#f00' : type === 'warning' ? '#ff0' : '#0f0') + ';';
    logEntry.textContent = `[${time}] ${type.toUpperCase()}: ${message}`;
    if (error && error.stack) {
      const stackEntry = document.createElement('div');
      stackEntry.style.cssText = 'margin-left:10px;font-size:10px;color:#888;';
      stackEntry.textContent = error.stack.split('\n').slice(0, 3).join('\n');
      logEntry.appendChild(stackEntry);
    }
    debugDiv.appendChild(logEntry);
    debugDiv.scrollTop = debugDiv.scrollHeight;
    
    // æœ€å¤§50ä»¶ã¾ã§ä¿æŒ
    while (debugDiv.children.length > 50) {
      debugDiv.removeChild(debugDiv.firstChild);
    }
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  window.addEventListener('error', (event) => {
    addDebugLog('error', `${event.message} (${event.filename}:${event.lineno}:${event.colno})`, event.error);
  });
  
  // Promise rejection ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  window.addEventListener('unhandledrejection', (event) => {
    addDebugLog('error', `Unhandled Promise Rejection: ${event.reason}`, event.reason);
  });
  
  // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚‚ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  const originalConsoleError = console.error;
  console.error = function(...args) {
    originalConsoleError.apply(console, args);
    addDebugLog('error', args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
  };
  
  addDebugLog('info', 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹');
})();
</script>
</body>
</html>
